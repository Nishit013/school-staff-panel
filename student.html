<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
  --bg:#0f1220;
  --surface:#151a2e;
  --surface-2:#1b2240;
  --text:#e9eefb;
  --muted:#a6b0cf;
  --primary:#00bcd4;
  --primary-2:#0097a7;
  --success:#21c064;
  --danger:#ff4f4f;
  --warn:#f0c419;
  --card:#151a2e;
  --border:#253058;
  --shadow:0 10px 30px rgba(0,0,0,.35);
}

[data-theme="light"] {
  --bg:#f6f8ff;
  --surface:#ffffff;
  --surface-2:#f3f6ff;
  --text:#0b1635;
  --muted:#47517a;
  --primary:#007c8a;
  --primary-2:#00a1b3;
  --success:#1e9c54;
  --danger:#e03b3b;
  --warn:#cc9c10;
  --card:#ffffff;
  --border:#e3e8ff;
  --shadow:0 8px 24px rgba(10,42,120,.08);
}

/* ========== BASE ========== */
* { box-sizing:border-box; }
html,body { height:100%; }

body {
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ========== NAVBAR ========== */
.nav {
  position:sticky;
  top:0;
  z-index:50;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  background:var(--surface);
  border-bottom:1px solid var(--border);
}
.brand {
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:700;
}
.brand .logo {
  width:32px;
  height:32px;
  display:grid;
  place-items:center;
  border-radius:10px;
  background:linear-gradient(135deg,var(--primary),var(--primary-2));
  color:white;
  box-shadow:0 6px 16px rgba(0, 188, 212, .25);
}

/* ========== LAYOUT ========== */
.wrap {
  padding:14px;
  max-width:1100px;
  margin:0 auto;
}

/* ========== PROFILE CARD ========== */
.profile {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  margin-top:14px;
  box-shadow:var(--shadow);
}
.profile h2 { margin:0 0 6px; font-size:20px; }
.profile .meta { color:var(--muted); font-size:14px; }

/* ========== KPI CARDS ========== */
.analytics {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-top:12px;
}
.kpi {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  display:flex;
  align-items:center;
  gap:12px;
  box-shadow:var(--shadow);
}
.kpi .icon { width:40px; height:40px; border-radius:10px; display:grid; place-items:center; }
.kpi .meta { line-height:1.2; }
.kpi .val { font-size:20px; font-weight:700; }
.icon.green { background:#163222; color:#7ff0a8; }
.icon.red { background:#3b1a1a; color:#ff8a8a; }
.icon.blue { background:#0f2730; color:#8de9f6; }

@media (min-width:680px) {
  .analytics { grid-template-columns:repeat(3,1fr); }
}

/* ========== SECTIONS ========== */
.section {
  margin-top:14px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}
.section h3 { margin:0 0 10px 0; font-size:18px; }

/* ========== HOMEWORK LIST ========== */
.homework-list { display:grid; gap:10px; }
.homework {
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  background:var(--surface-2);
}
.homework .title { font-weight:600; }
.homework .date { font-size:12px; color:var(--muted); margin-top:4px; }

/* ========== CHART ========== */
#attendanceChart {
  width:100%;
  height:300px;
  background:var(--surface-2);
  border-radius:12px;
  margin-top:10px;
}



/* ========== MODAL BASE ========== */
.modal {
  position:fixed;
  top:0; left:0;
  width:100%;
  height:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,0.7);
  z-index:1000;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.3s ease;
}
.modal.show {
  opacity:1;
  pointer-events:auto;
}

/* ========== MODAL CONTENT ========== */
.modal-content {
  background:var(--surface);
  color:var(--text);
  padding:24px;
  border-radius:14px;
  max-width:420px;
  width:90%;
  box-shadow:var(--shadow);
  animation:popIn 0.3s ease;
  position:relative;
}
@keyframes popIn {
  0% { transform:scale(0.8); opacity:0; }
  100% { transform:scale(1); opacity:1; }
}
.modal-content .close {
  position:absolute;
  top:10px;
  right:15px;
  font-size:22px;
  color:var(--muted);
  cursor:pointer;
  transition:color 0.2s ease;
}
.modal-content .close:hover {
  color:var(--text);
}

/* ========== HOMEWORK MODAL ========== */
#modalHomeworkList ul {
  padding-left:16px;
  margin:8px 0 0 0;
}
#modalHomeworkList li {
  margin-bottom:6px;
  font-size:14px;
  line-height:1.4;
}
#modalDate {
  font-weight:700;
  margin-bottom:10px;
  display:block;
  font-size:16px;
  color:var(--primary);
}

/* ========== MESSAGE BUTTON & MODAL ========== */
.student-card .message-btn,
.message-btn {
  float:right;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer;
  transition:background 0.3s ease;
}
.message-btn:hover {
  background:var(--primary-2);
}

/* Message Modal Extra */
#studentMessagesContainer {
  background:var(--surface-2);
  border-radius:10px;
  border:1px solid var(--border);
  padding:10px;
  height:250px;
  overflow-y:auto;
  margin-bottom:10px;
}

#studentMessageInput {
  width:100%;
  background:var(--surface-2);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  margin-bottom:8px;
}

#studentMessageModal button {
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:8px 14px;
  cursor:pointer;
  transition:background 0.3s ease;
}
#studentMessageModal button:hover {
  background:var(--primary-2);
}

/* Optional scrollbar polish */
#studentMessagesContainer::-webkit-scrollbar {
  width:8px;
}
#studentMessagesContainer::-webkit-scrollbar-thumb {
  background:var(--primary-2);
  border-radius:10px;
}
#studentMessagesContainer::-webkit-scrollbar-track {
  background:var(--surface);
}





/* === Calendar Header === */
#calendarContainer .calendar-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 12px;
}

#calendarContainer .calendar-header .month-label {
  font-weight: 700;
  color: var(--primary);
  font-size: 1.1rem;
}

#calendarContainer .calendar-header .cal-nav {
  background: transparent;
  border: none;
  color: var(--primary);
  font-size: 22px;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 8px;
  transition: background 0.2s;
}

#calendarContainer .calendar-header .cal-nav:hover {
  background: rgba(0, 188, 212, 0.15);
}

/* === Weekday Row === */
#calendarContainer .calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 10px;
  margin-bottom: 6px;
  text-align: center;
}

#calendarContainer .calendar-weekdays .weekday {
  font-size: 14px;
  font-weight: 600;
  color: #aaa;
}

/* === Calendar Grid === */
#calendarContainer .calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 10px;
}

/* === Calendar Cells === */
#calendarContainer .calendar-day,
#calendarContainer .calendar-other {
  position: relative;
  border-radius: 12px;
  text-align: center;
  min-height: 80px; /* bigger size */
  display: flex;
  align-items: flex-start;
  justify-content: flex-end;
  padding: 8px;
  font-size: 15px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  transition: transform 0.15s ease, background 0.2s ease;
}

#calendarContainer .calendar-day:hover {
  transform: scale(1.05);
  background: rgba(0, 188, 212, 0.15);
}

/* Previous/Next month muted days */
#calendarContainer .calendar-other {
  color: rgba(255, 255, 255, 0.3);
}

/* Day numbers */
#calendarContainer .calendar-day .day-num {
  position: absolute;
  top: 8px;
  right: 8px;
  font-weight: 600;
}

/* Today highlight */
#calendarContainer .calendar-day.today {
  border: 2px solid var(--primary);
  box-shadow: 0 0 10px rgba(0, 188, 212, 0.4);
}

/* Homework highlight */
#calendarContainer .calendar-day.hasHomework {
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
  color: #fff;
  border: none;
}

/* Optional: small homework dot indicator */
#calendarContainer .calendar-day.hasHomework::after {
  content: "â€¢";
  position: absolute;
  bottom: 8px;
  left: 8px;
  font-size: 22px;
  color: #ffeb3b;
}




/* LOGIN PANEL STYLING */
/* Always center login panel */
.login-container {
  position: fixed;     /* fixed to viewport */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;       /* flex centering */
  justify-content: center;
  align-items: center;
  background: var(--bg);
  z-index: 9999;       /* on top of everything */
  transition: opacity 0.3s ease;
}

.login-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 40px 30px;
  width: 350px;
  max-width: 90%;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 20px;
  transition: transform 0.3s, box-shadow 0.3s;
}

.login-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.5);
}

.login-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.login-header .logo {
  width: 60px;
  height: 60px;
  display: grid;
  place-items: center;
  font-size: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg,var(--primary),var(--primary-2));
  color: white;
  box-shadow: 0 8px 20px rgba(0,188,212,0.3);
}

.login-header h2 {
  margin: 0;
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
}

.login-body {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.login-body input {
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.login-body input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 8px rgba(0,188,212,0.4);
}

.login-body button {
  padding: 12px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  background: linear-gradient(135deg,var(--primary),var(--primary-2));
  color: #fff;
  transition: transform 0.2s, box-shadow 0.2s;
}

.login-body button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,188,212,0.4);
}

.login-error {
  color: var(--danger);
  font-size: 13px;
  text-align: center;
  min-height: 18px;
}

.login-footer {
  text-align: center;
  font-size: 12px;
  color: var(--muted);
  margin-top: 10px;
}





/* Same timetable styles reused */
.section {
  margin: 40px auto;
  padding: 20px;
  width: 95%;
  background: var(--surface, #1b1f32);
  color: white;
  border-radius: 16px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.section h2 {
  text-align: center;
  font-size: 1.6em;
  color: var(--primary, #00bcd4);
  margin-bottom: 20px;
}

.timetable-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
  gap: 10px;
}

.timetable-controls select {
  padding: 8px 15px;
  background: #222846;
  color: #fff;
  border: 1px solid #444;
  border-radius: 8px;
  outline: none;
}

#timetableTable {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
  background: rgba(255, 255, 255, 0.05);
}

#timetableTable th, #timetableTable td {
  padding: 10px;
  border: 1px solid rgba(255,255,255,0.1);
}

#timetableTable th {
  background: var(--primary, #00bcd4);
  color: white;
  font-weight: 600;
}

#timetableTable td {
  transition: background 0.2s;
}

#timetableTable td:hover {
  background: rgba(0,188,212,0.1);
}

/* Disabled dropdown */
#studentClass[disabled] {
  opacity: 0.7;
  cursor: not-allowed;
}
#timetableTable td, #timetableTable th {
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.1);
  text-align: center;
}

#timetableTable tr:nth-child(even) {
  background: rgba(255,255,255,0.03);
}

#timetableTable tr.break-row td {
  background: #333;
  color: #aaa;
  font-style: italic;
  text-align: center;
}

#timetableTable td {
  padding: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  text-align: center;
}

#timetableTable td:nth-child(4),
#timetableTable td:nth-child(7) {
  background: #444;
  color: #ccc;
  font-style: italic;
}


</style>
</head>
<body>
  <div class="nav">
    <div class="brand"><div class="logo">ðŸŽ“</div> Student Panel</div>
  </div>

  <div class="wrap">

    <!-- LOGIN PANEL -->
    <!-- LOGIN PANEL -->
<div id="loginPanel" class="login-container">
  <div class="login-card">
    <div class="login-header">
      <div class="logo">ðŸ“š</div>
      <h2>Student Login</h2>
    </div>
    <div class="login-body">
      <input type="text" id="studentID" placeholder="Enter Your Student ID">
      <button class="btn primary" onclick="loginStudent()">Login</button>
      <div id="loginError" class="login-error"></div>
    </div>
    <div class="login-footer">
      <small>Â© 2025 KREA School Management</small>
    </div>
  </div>
</div>


    <!-- DASHBOARD (hidden until login) -->
    <div id="dashboard" style="display:none;">
      <!-- Profile -->
      <div class="profile">
        <h2 id="studentName">Student Name</h2>
        <div class="meta">Class: <span id="studentClass">--</span></div>
        <div class="meta">Email: <span id="studentEmailShow">--</span></div>
        <button class="btn ghost" onclick="logout()">Logout</button>
      </div>

      <!-- KPIs -->
      <div class="analytics">
        <div class="kpi"><div class="icon green">âœ”</div>
          <div><div class="meta">Total Present</div><div id="kpiPresent" class="val">0</div></div>
        </div>
        <div class="kpi"><div class="icon red">âœ–</div>
          <div><div class="meta">Total Absent</div><div id="kpiAbsent" class="val">0</div></div>
        </div>
        <div class="kpi"><div class="icon blue">%</div>
          <div><div class="meta">Attendance %</div><div id="kpiPercent" class="val">0%</div></div>
        </div>
      </div>
<div id="studentContainer" style="margin-top:16px;"></div>
      <!-- Attendance Graph -->
      <div class="section">
        <h3>Attendance This Month</h3>
        <canvas id="attendanceChart"></canvas>
      </div>

      <!-- Homework Section -->
      <div id="homeworkPanelStudent">
  <h3>ðŸ“… Homework Calendar</h3>
  <div id="calendarContainer"></div>
</div>

<!-- Homework Modal -->
<!-- Homework Modal -->
<div id="homeworkModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeHomeworkModal()">&times;</span>
    <h3>Homework - <span id="modalDate"></span></h3>
    <div id="modalHomeworkList"></div>
  </div>
</div>


    </div>

  </div>
<!-- Student Message Modal -->
<!-- ðŸ’¬ Student Message Modal -->
<div id="studentMessageModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeStudentMessageModal()">&times;</span>
    <h2>Messages</h2>
    <div class="messages-box" id="studentMessagesBox" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:5px;">
      <!-- messages will load here -->
      <p class="empty-msg" style="text-align:center; color:gray;">No messages yet</p>
    </div>
    <div class="message-input" style="margin-top:10px; display:flex; gap:5px;">
      <input type="text" id="studentMessageInput" placeholder="Type your message..." style="flex:1;" />
      <button id="sendStudentMsg">Send</button>
    </div>
  </div>
</div>

<div id="panel-timetable" class="panel">
  <div id="timetable-section" class="section">
    <h2>ðŸ“… My Class Timetable</h2>

    <div class="timetable-controls">
      <label for="studentClassSelect">Class:</label>
      <select id="studentClassSelect" disabled></select>
    </div>

    <div class="timetable-container">
      <table id="timetableTable">
  <thead>
    <tr>
      <th>Day</th>
      <th>Period 1</th>
      <th>Period 2</th>
      <th>Break</th>
      <th>Period 3</th>
      <th>Period 4</th>
      <th>Break</th>
      <th>Period 5</th>
      <th>Period 6</th>
    </tr>
  </thead>
  <tbody id="timetableBody"></tbody>
</table>

    </div>
  </div>
</div>




  <div class="footer-space"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
  // 1. Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCfffexgO1rf6m6EteNNtFb_kZnRqqTUBM",
    authDomain: "schoolmanagementsystem-32895.firebaseapp.com",
    databaseURL: "https://schoolmanagementsystem-32895-default-rtdb.firebaseio.com",
    projectId: "schoolmanagementsystem-32895",
    storageBucket: "schoolmanagementsystem-32895.appspot.com",
    messagingSenderId: "837516759841",
    appId: "1:837516759841:web:31d6666b15037082fa6460"
  };

  // 2. Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentStudent = null;

  // ===== LOGIN FUNCTION =====
  async function loginStudent() {
    const studentID = document.getElementById("studentID").value.trim();
    if (!studentID) {
      document.getElementById('loginError').textContent = "Enter your Student ID!";
      return;
    }

    try {
      const snap = await db.ref(`users/${studentID}`).once('value');
      const studentData = snap.val();

      if (!studentData || studentData.role !== "student") {
        document.getElementById('loginError').textContent = "Invalid Student ID!";
        return;
      }

      currentStudent = { uid: studentID, ...studentData };
      showDashboard(currentStudent);

    } catch (err) {
      document.getElementById('loginError').textContent = "Error: " + err.message;
    }
  }

  // ===== SHOW DASHBOARD =====
  // ===== SHOW DASHBOARD =====
function showDashboard(student) {
  document.getElementById('loginPanel').style.display = "none";  // hide login
  document.getElementById('dashboard').style.display = "block";

  document.getElementById('studentName').textContent = student.name;
  document.getElementById('studentClass').textContent = student.class || "--";
  document.getElementById('studentEmailShow').textContent = student.email || "--";

  currentStudentUid = student.uid;

  // Load attendance
  loadAttendance(student.class, student.uid);

  // Load homework calendar
  if (student.class) {
    loadHomeworkCalendar(student.class);
  } else {
    document.getElementById('calendarContainer').innerHTML =
      "<p>Your class is not assigned yet.</p>";
  }

  // Load student panel
  loadStudentPanel();

  // ===== NEW: Load timetable =====
  if (student.class) {
    // Fill class dropdown (read-only)
    const select = document.getElementById("studentClassSelect");
    select.innerHTML = `<option value="${student.class}">${student.class}</option>`;

    // Show timetable panel
    document.getElementById("panel-timetable").style.display = "block";

    // Load timetable from Firebase
    loadStudentTimetable(student.class);
  } else {
    // Hide timetable if no class assigned
    document.getElementById("panel-timetable").style.display = "none";
  }
}




  // ===== LOGOUT =====
  function logout() {
  currentStudent = null;
  const loginPanel = document.getElementById('loginPanel');
  loginPanel.style.display = "flex";  // <-- keep it flex to stay centered
  document.getElementById('dashboard').style.display = "none";
  document.getElementById('studentID').value = "";
  document.getElementById('loginError').textContent = ""; // optional: clear error
}


  // ===== AUTH STATE LISTENER =====
  
  // ===== LOAD ATTENDANCE =====
  async function loadAttendance(className, studentUID) {
    const snap = await db.ref(`attendance/${className}`).once('value');
    const data = snap.val() || {};

    let totalDays = 0, present = 0, absent = 0;
    const monthlyCounts = {};

    Object.keys(data).forEach(date => {
      const status = data[date]?.[studentUID];
      if (!status) return;
      totalDays++;
      if (status === "Present") present++;
      if (status === "Absent") absent++;

      const monthKey = date.slice(0,7);
      if (!monthlyCounts[monthKey]) monthlyCounts[monthKey] = { present:0, total:0 };
      monthlyCounts[monthKey].total++;
      if (status === "Present") monthlyCounts[monthKey].present++;
    });

    document.getElementById('kpiPresent').textContent = present;
    document.getElementById('kpiAbsent').textContent = absent;
    document.getElementById('kpiPercent').textContent = totalDays ? Math.round((present/totalDays)*100) + "%" : "0%";

    const labels = Object.keys(monthlyCounts).sort();
    const dataPoints = labels.map(m => Math.round((monthlyCounts[m].present / monthlyCounts[m].total)*100));

    const ctx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[{ label:'% Attendance', data:dataPoints, backgroundColor:'rgba(54,162,235,0.6)' }] },
      options:{ responsive:true, scales:{y:{beginAtZero:true,max:100}} }
    });
  }

  // ===== LOAD HOMEWORK CALENDAR =====
 // Calendar helpers & state
let calendarYear = null;
let calendarMonth = null; // 0-11
let calendarClassId = null;

function pad(n){ return String(n).padStart(2,'0'); }
function formatDateYYYYMMDD(date){
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
}

const MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];

/**
 * Load & render calendar for a class, optional year/month.
 * If year/month not provided, it renders current month.
 */
async function loadHomeworkCalendar(classId, year=null, month=null) {
  calendarClassId = classId;

  // default to current month/year
  const now = new Date();
  if (year === null) year = now.getFullYear();
  if (month === null) month = now.getMonth();

  calendarYear = year;
  calendarMonth = month;

  // fetch homework for this class (we'll check dates locally)
  const snap = await db.ref(`homework/${classId}`).once('value');
  const allHW = snap.val() || {};

  const cal = document.getElementById('calendarContainer');
  cal.innerHTML = ''; // clear

  // header with prev/next
  const header = document.createElement('div');
  header.className = 'calendar-header';
  header.innerHTML = `
    <button type="button" class="cal-nav" aria-label="Previous month" onclick="prevCalendarMonth()">â€¹</button>
    <div class="month-label">${MONTH_NAMES[calendarMonth]} ${calendarYear}</div>
    <button type="button" class="cal-nav" aria-label="Next month" onclick="nextCalendarMonth()">â€º</button>
  `;
  cal.appendChild(header);

  // weekday headings (optional)
  const weekNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const weekRow = document.createElement('div');
  weekRow.className = 'calendar-weekdays';
  weekRow.innerHTML = weekNames.map(w => `<div class="weekday">${w}</div>`).join('');
  cal.appendChild(weekRow);

  // grid container
  const grid = document.createElement('div');
  grid.className = 'calendar-grid';

  // compute needed values
  const firstDay = new Date(calendarYear, calendarMonth, 1);
  const startWeekday = firstDay.getDay(); // 0(Sun) - 6(Sat)
  const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
  const prevMonthLastDay = new Date(calendarYear, calendarMonth, 0).getDate(); // last day of prev month
  const todayStr = formatDateYYYYMMDD(new Date());

  // render leading previous-month days (optional, muted)
  for (let i = 0; i < startWeekday; i++) {
    const dayNum = prevMonthLastDay - (startWeekday - 1 - i);
    const el = document.createElement('div');
    el.className = 'calendar-other';
    el.textContent = dayNum;
    grid.appendChild(el);
  }

  // render days of current month
  for (let d = 1; d <= daysInMonth; d++) {
    const dateObj = new Date(calendarYear, calendarMonth, d);
    const dateStr = formatDateYYYYMMDD(dateObj);

    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    if (dateStr === todayStr) cell.classList.add('today');

    // mark homework
    if (allHW[dateStr]) {
      cell.classList.add('hasHomework');
    }

    cell.dataset.date = dateStr;
    cell.innerHTML = `<div class="day-num">${d}</div>`;

    // only those days should be clickable
    cell.style.cursor = 'pointer';
    cell.addEventListener('click', () => {
      // call your existing handler
      showHomework(calendarClassId, dateStr);
    });

    grid.appendChild(cell);
  }

  // render trailing next-month cells (optional to keep grid tidy up to 42 cells)
  // compute total cells to make full weeks (optional)
  const totalCells = startWeekday + daysInMonth;
  const trailing = (totalCells % 7) === 0 ? 0 : (7 - (totalCells % 7));
  for (let t = 1; t <= trailing; t++) {
    const el = document.createElement('div');
    el.className = 'calendar-other';
    el.textContent = t;
    grid.appendChild(el);
  }

  cal.appendChild(grid);
}

/* navigation helpers */
function prevCalendarMonth(){
  let m = calendarMonth - 1;
  let y = calendarYear;
  if (m < 0) { m = 11; y -= 1; }
  loadHomeworkCalendar(calendarClassId, y, m);
}
function nextCalendarMonth(){
  let m = calendarMonth + 1;
  let y = calendarYear;
  if (m > 11) { m = 0; y += 1; }
  loadHomeworkCalendar(calendarClassId, y, m);
}



  // ===== SHOW HOMEWORK MODAL =====
// Show Homework Modal
// ===== HOMEWORK MODAL =====
async function showHomework(classId, date) {
  const modal = document.getElementById('homeworkModal');
  const modalList = document.getElementById('modalHomeworkList');
  document.getElementById('modalDate').textContent = date;

  const snap = await db.ref(`homework/${classId}/${date}`).once('value');
  const data = snap.val();

  let html = "<ul>";
  if (!data) html += "<li>No homework uploaded.</li>";
  else if (typeof data === "string") html += `<li>${data}</li>`;
  else
    Object.entries(data).forEach(([sub, hw]) => {
      html += `<li><strong>${sub}:</strong> ${hw}</li>`;
    });
  html += "</ul>";

  modalList.innerHTML = html;
  modal.classList.add('show');
}

// ===== CLOSE HOMEWORK MODAL =====
function closeHomeworkModal() {
  document.getElementById('homeworkModal').classList.remove('show');
}

// ===== GLOBAL VARIABLES =====
let studentMessageListener = null;
let currentStudentUid = null;
let lastTeacherUID = null;

// ===== OPEN STUDENT MESSAGE MODAL =====
function openStudentMessageModal(studentUid) {
  currentStudentUid = studentUid;
  const modal = document.getElementById('studentMessageModal');
  modal.classList.add('show');

  const container = document.getElementById('studentMessagesBox');
  container.innerHTML = "<p style='color:gray;text-align:center;'>Loading messages...</p>";

  // Remove previous listener
  if (studentMessageListener)
    db.ref(`messages/${studentUid}`).off('value', studentMessageListener);

  studentMessageListener = db.ref(`messages/${studentUid}`).on('value', async snap => {
    const teachersMessages = snap.val() || {};
    const allMessages = [];

    // Collect all messages with teacher info
    for (const teacherUID in teachersMessages) {
      const teacherSnap = await db.ref(`users/${teacherUID}`).once('value');
      const teacherData = teacherSnap.val();
      const teacherName = teacherData ? teacherData.name : "Teacher";
      const msgs = teachersMessages[teacherUID];

      for (const ts in msgs) {
        const msgObj = msgs[ts];
        const msgText = typeof msgObj === "string" ? msgObj : msgObj.text;
        const senderRole = msgObj.senderRole || "teacher";
        const senderName = msgObj.senderName || teacherName;

        allMessages.push({
          teacherUID,
          teacherName,
          ts,
          text: msgText,
          senderRole,
          senderName
        });
      }
    }

    // Sort all messages by timestamp
    allMessages.sort((a, b) => parseInt(a.ts) - parseInt(b.ts));

    container.innerHTML = "";
    if (allMessages.length === 0) {
      container.innerHTML = "<p style='color:gray;text-align:center;'>No messages yet.</p>";
      lastTeacherUID = null;
      return;
    }

    // Render messages in time order
    allMessages.forEach(msg => {
      const div = document.createElement("div");
      div.style.margin = "6px";
      div.style.padding = "8px 12px";
      div.style.borderRadius = "10px";
      div.style.maxWidth = "75%";
      div.style.wordBreak = "break-word";
      div.style.background =
        msg.senderRole === "teacher" ? "#00bcd4" : "#e0e0e0";
      div.style.color = msg.senderRole === "teacher" ? "#fff" : "#000";
      div.style.alignSelf =
        msg.senderRole === "teacher" ? "flex-start" : "flex-end";
      div.innerHTML = `
        <strong>${msg.senderName}:</strong> ${msg.text}
        <br>
        <small style="font-size:10px;opacity:0.7;">
          ${new Date(parseInt(msg.ts)).toLocaleString()}
        </small>
      `;
      container.appendChild(div);
    });

    // Update lastTeacherUID = the sender of the most recent teacher message
    const latestTeacherMsg = [...allMessages]
      .reverse()
      .find(m => m.senderRole === "teacher");
    if (latestTeacherMsg) lastTeacherUID = latestTeacherMsg.teacherUID;

    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
  });
}

// ===== CLOSE MESSAGE MODAL =====
function closeStudentMessageModal() {
  const modal = document.getElementById("studentMessageModal");
  modal.classList.remove("show");

  const container = document.getElementById("studentMessagesBox");
  container.innerHTML = "";

  if (studentMessageListener)
    db.ref(`messages/${currentStudentUid}`).off("value", studentMessageListener);
  lastTeacherUID = null;
}

// ===== SEND MESSAGE TO TEACHER =====
async function sendMessageToTeacher() {
  const input = document.getElementById("studentMessageInput");
  const text = input.value.trim();
  if (!text) return alert("Enter a message!");
  if (!currentStudentUid) return alert("Student UID missing!");
  if (!lastTeacherUID) return alert("No teacher to reply to yet!");

  const studentSnap = await db.ref(`users/${currentStudentUid}`).once("value");
  const studentData = studentSnap.val();
  const timestamp = Date.now();

  await db
    .ref(`messages/${currentStudentUid}/${lastTeacherUID}/${timestamp}`)
    .set({
      text,
      senderRole: "student",
      senderName: studentData.name,
      senderUid: currentStudentUid,
      timestamp,
    });

  input.value = "";
}

// ===== LOAD STUDENT PANEL =====
async function loadStudentPanel() {
  const container = document.getElementById("studentContainer");
  container.innerHTML = "Loadingâ€¦";

  const studentSnap = await db.ref(`users/${currentStudentUid}`).once("value");
  const studentData = studentSnap.val();

  container.innerHTML = `
    <div class="student-card" style="border:1px solid var(--border); padding:10px; border-radius:12px; margin-bottom:8px; background:var(--card)">
      <div class="row" style="display:flex; justify-content:space-between; align-items:center;">
        <div class="name">${studentData.name}</div>
        <button id="messageBtn" class="message-btn" title="Open Messages">ðŸ’¬</button>
      </div>
    </div>
  `;

  document
    .getElementById("messageBtn")
    .addEventListener("click", () => openStudentMessageModal(currentStudentUid));
  document
    .getElementById("sendStudentMsg")
    .addEventListener("click", sendMessageToTeacher);
}




const timetableRef = db.ref("timetable");

// Load timetable for a given class
function loadStudentTimetable(className) {
  timetableRef.child(className).once("value").then(snap => {
    const timetable = snap.val() || {};
    renderStudentTimetable(timetable);
  }).catch(err => {
    console.error("Error loading timetable:", err);
    document.getElementById("timetableBody").innerHTML = "<tr><td colspan='9'>Failed to load timetable.</td></tr>";
  });
}

// Render timetable in the table
function renderStudentTimetable(timetable) {
  const tbody = document.getElementById("timetableBody");
  tbody.innerHTML = "";

  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

  days.forEach(day => {
    const dayData = timetable[day] || {};
    const tr = document.createElement("tr");

    tr.innerHTML = `<td><b>${day}</b></td>`;

    // Period 1 & 2
    tr.innerHTML += `<td>${dayData["Period1"] || "-"}</td>`;
    tr.innerHTML += `<td>${dayData["Period2"] || "-"}</td>`;

    // Break column
    tr.innerHTML += `<td style="background:#444; color:#ccc; font-style:italic;">Break</td>`;

    // Period 3 & 4
    tr.innerHTML += `<td>${dayData["Period3"] || "-"}</td>`;
    tr.innerHTML += `<td>${dayData["Period4"] || "-"}</td>`;

    // Break column
    tr.innerHTML += `<td style="background:#444; color:#ccc; font-style:italic;">Break</td>`;

    // Period 5 & 6
    tr.innerHTML += `<td>${dayData["Period5"] || "-"}</td>`;
    tr.innerHTML += `<td>${dayData["Period6"] || "-"}</td>`;

    tbody.appendChild(tr);
  });
}



  </script>

</body>
</html>
