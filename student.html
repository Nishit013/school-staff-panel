<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
  --bg:#0f1220;
  --surface:#151a2e;
  --surface-2:#1b2240;
  --text:#e9eefb;
  --muted:#a6b0cf;
  --primary:#00bcd4;
  --primary-2:#0097a7;
  --success:#21c064;
  --danger:#ff4f4f;
  --warn:#f0c419;
  --card:#151a2e;
  --border:#253058;
  --shadow:0 10px 30px rgba(0,0,0,.35);
}

[data-theme="light"] {
  --bg:#f6f8ff;
  --surface:#ffffff;
  --surface-2:#f3f6ff;
  --text:#0b1635;
  --muted:#47517a;
  --primary:#007c8a;
  --primary-2:#00a1b3;
  --success:#1e9c54;
  --danger:#e03b3b;
  --warn:#cc9c10;
  --card:#ffffff;
  --border:#e3e8ff;
  --shadow:0 8px 24px rgba(10,42,120,.08);
}

/* ========== BASE ========== */
* { box-sizing:border-box; }
html,body { height:100%; }

body {
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ========== NAVBAR ========== */
.nav {
  position:sticky;
  top:0;
  z-index:50;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  background:var(--surface);
  border-bottom:1px solid var(--border);
}
.brand {
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:700;
}
.brand .logo {
  width:32px;
  height:32px;
  display:grid;
  place-items:center;
  border-radius:10px;
  background:linear-gradient(135deg,var(--primary),var(--primary-2));
  color:white;
  box-shadow:0 6px 16px rgba(0, 188, 212, .25);
}

/* ========== LAYOUT ========== */
.wrap {
  padding:14px;
  max-width:1100px;
  margin:0 auto;
}

/* ========== PROFILE CARD ========== */
.profile {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  margin-top:14px;
  box-shadow:var(--shadow);
}
.profile h2 { margin:0 0 6px; font-size:20px; }
.profile .meta { color:var(--muted); font-size:14px; }

/* ========== KPI CARDS ========== */
.analytics {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-top:12px;
}
.kpi {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  display:flex;
  align-items:center;
  gap:12px;
  box-shadow:var(--shadow);
}
.kpi .icon { width:40px; height:40px; border-radius:10px; display:grid; place-items:center; }
.kpi .meta { line-height:1.2; }
.kpi .val { font-size:20px; font-weight:700; }
.icon.green { background:#163222; color:#7ff0a8; }
.icon.red { background:#3b1a1a; color:#ff8a8a; }
.icon.blue { background:#0f2730; color:#8de9f6; }

@media (min-width:680px) {
  .analytics { grid-template-columns:repeat(3,1fr); }
}

/* ========== SECTIONS ========== */
.section {
  margin-top:14px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}
.section h3 { margin:0 0 10px 0; font-size:18px; }

/* ========== HOMEWORK LIST ========== */
.homework-list { display:grid; gap:10px; }
.homework {
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  background:var(--surface-2);
}
.homework .title { font-weight:600; }
.homework .date { font-size:12px; color:var(--muted); margin-top:4px; }

/* ========== CHART ========== */
#attendanceChart {
  width:100%;
  height:300px;
  background:var(--surface-2);
  border-radius:12px;
  margin-top:10px;
}

/* ========== CALENDAR ========== */
#calendarContainer {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
  margin-top:16px;
  padding:10px;
  background:var(--surface);
  border-radius:12px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}

.calendar-day {
  padding:14px 0;
  border-radius:10px;
  text-align:center;
  cursor:pointer;
  background-color:var(--surface-2);
  color:var(--text);
  font-weight:600;
  font-size:14px;
  transition:all 0.2s ease;
  border:1px solid var(--border);
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  min-height:50px;
}
.calendar-day.today {
  border:2px solid var(--primary);
  box-shadow:0 0 8px rgba(0,188,212,0.6);
}
.calendar-day.hasHomework {
  background:var(--primary);
  color:#fff;
  font-weight:700;
  border-color:var(--primary-2);
}
.calendar-day:hover {
  transform:translateY(-2px);
  box-shadow:0 6px 12px rgba(0,0,0,0.3);
  background:var(--primary-2);
  color:#fff;
}
.calendar-day.hasHomework::after {
  content:'';
  display:block;
  width:6px;
  height:6px;
  border-radius:50%;
  background:#ffdd57;
  margin-top:4px;
}

/* ========== MODAL BASE ========== */
.modal {
  position:fixed;
  top:0; left:0;
  width:100%;
  height:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,0.7);
  z-index:1000;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.3s ease;
}
.modal.show {
  opacity:1;
  pointer-events:auto;
}

/* ========== MODAL CONTENT ========== */
.modal-content {
  background:var(--surface);
  color:var(--text);
  padding:24px;
  border-radius:14px;
  max-width:420px;
  width:90%;
  box-shadow:var(--shadow);
  animation:popIn 0.3s ease;
  position:relative;
}
@keyframes popIn {
  0% { transform:scale(0.8); opacity:0; }
  100% { transform:scale(1); opacity:1; }
}
.modal-content .close {
  position:absolute;
  top:10px;
  right:15px;
  font-size:22px;
  color:var(--muted);
  cursor:pointer;
  transition:color 0.2s ease;
}
.modal-content .close:hover {
  color:var(--text);
}

/* ========== HOMEWORK MODAL ========== */
#modalHomeworkList ul {
  padding-left:16px;
  margin:8px 0 0 0;
}
#modalHomeworkList li {
  margin-bottom:6px;
  font-size:14px;
  line-height:1.4;
}
#modalDate {
  font-weight:700;
  margin-bottom:10px;
  display:block;
  font-size:16px;
  color:var(--primary);
}

/* ========== MESSAGE BUTTON & MODAL ========== */
.student-card .message-btn,
.message-btn {
  float:right;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer;
  transition:background 0.3s ease;
}
.message-btn:hover {
  background:var(--primary-2);
}

/* Message Modal Extra */
#studentMessagesContainer {
  background:var(--surface-2);
  border-radius:10px;
  border:1px solid var(--border);
  padding:10px;
  height:250px;
  overflow-y:auto;
  margin-bottom:10px;
}

#studentMessageInput {
  width:100%;
  background:var(--surface-2);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  margin-bottom:8px;
}

#studentMessageModal button {
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:8px 14px;
  cursor:pointer;
  transition:background 0.3s ease;
}
#studentMessageModal button:hover {
  background:var(--primary-2);
}

/* Optional scrollbar polish */
#studentMessagesContainer::-webkit-scrollbar {
  width:8px;
}
#studentMessagesContainer::-webkit-scrollbar-thumb {
  background:var(--primary-2);
  border-radius:10px;
}
#studentMessagesContainer::-webkit-scrollbar-track {
  background:var(--surface);
}



</style>
</head>
<body>
  <div class="nav">
    <div class="brand"><div class="logo">ðŸŽ“</div> Student Panel</div>
  </div>

  <div class="wrap">

    <!-- LOGIN PANEL -->
    <div id="loginPanel" class="profile">
      <h2>Student Login</h2>
      <div>
        <input type="text" id="studentID" placeholder="Enter Your Student ID" 
               style="padding:8px; width:100%; margin:5px 0; border-radius:8px;">
        <button class="btn primary" onclick="loginStudent()">Login</button>
        <div id="loginError" style="color:var(--danger); margin-top:8px;"></div>
      </div>
    </div>

    <!-- DASHBOARD (hidden until login) -->
    <div id="dashboard" style="display:none;">
      <!-- Profile -->
      <div class="profile">
        <h2 id="studentName">Student Name</h2>
        <div class="meta">Class: <span id="studentClass">--</span></div>
        <div class="meta">Email: <span id="studentEmailShow">--</span></div>
        <button class="btn ghost" onclick="logout()">Logout</button>
      </div>

      <!-- KPIs -->
      <div class="analytics">
        <div class="kpi"><div class="icon green">âœ”</div>
          <div><div class="meta">Total Present</div><div id="kpiPresent" class="val">0</div></div>
        </div>
        <div class="kpi"><div class="icon red">âœ–</div>
          <div><div class="meta">Total Absent</div><div id="kpiAbsent" class="val">0</div></div>
        </div>
        <div class="kpi"><div class="icon blue">%</div>
          <div><div class="meta">Attendance %</div><div id="kpiPercent" class="val">0%</div></div>
        </div>
      </div>
<div id="studentContainer" style="margin-top:16px;"></div>
      <!-- Attendance Graph -->
      <div class="section">
        <h3>Attendance This Month</h3>
        <canvas id="attendanceChart"></canvas>
      </div>

      <!-- Homework Section -->
      <div id="homeworkPanelStudent">
  <h3>ðŸ“… Homework Calendar</h3>
  <div id="calendarContainer"></div>
</div>

<!-- Homework Modal -->
<!-- Homework Modal -->
<div id="homeworkModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeHomeworkModal()">&times;</span>
    <h3>Homework - <span id="modalDate"></span></h3>
    <div id="modalHomeworkList"></div>
  </div>
</div>


    </div>

  </div>
<!-- Student Message Modal -->
<!-- ðŸ’¬ Student Message Modal -->
<div id="studentMessageModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeStudentMessageModal()">&times;</span>
    <h2>Messages</h2>
    <div class="messages-box" id="studentMessagesBox">
      <!-- messages will load here -->
      <p class="empty-msg">No messages yet</p>
    </div>
    <div class="message-input">
      <input type="text" id="studentMessageInput" placeholder="Type your message..." />
      <button id="sendStudentMsg">Send</button>
    </div>
  </div>
</div>



  <div class="footer-space"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
  // 1. Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCfffexgO1rf6m6EteNNtFb_kZnRqqTUBM",
    authDomain: "schoolmanagementsystem-32895.firebaseapp.com",
    databaseURL: "https://schoolmanagementsystem-32895-default-rtdb.firebaseio.com",
    projectId: "schoolmanagementsystem-32895",
    storageBucket: "schoolmanagementsystem-32895.appspot.com",
    messagingSenderId: "837516759841",
    appId: "1:837516759841:web:31d6666b15037082fa6460"
  };

  // 2. Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentStudent = null;

  // ===== LOGIN FUNCTION =====
  async function loginStudent() {
    const studentID = document.getElementById("studentID").value.trim();
    if (!studentID) {
      document.getElementById('loginError').textContent = "Enter your Student ID!";
      return;
    }

    try {
      const snap = await db.ref(`users/${studentID}`).once('value');
      const studentData = snap.val();

      if (!studentData || studentData.role !== "student") {
        document.getElementById('loginError').textContent = "Invalid Student ID!";
        return;
      }

      currentStudent = { uid: studentID, ...studentData };
      showDashboard(currentStudent);

    } catch (err) {
      document.getElementById('loginError').textContent = "Error: " + err.message;
    }
  }

  // ===== SHOW DASHBOARD =====
  function showDashboard(student) {
  document.getElementById('loginPanel').style.display = "none";
  document.getElementById('dashboard').style.display = "block";

  document.getElementById('studentName').textContent = student.name;
  document.getElementById('studentClass').textContent = student.class || "--";
  document.getElementById('studentEmailShow').textContent = student.email || "--";

  currentStudentUid = student.uid; // <--- important

  loadAttendance(student.class, student.uid);

  if (student.class) {
    loadHomeworkCalendar(student.class);
  } else {
    document.getElementById('calendarContainer').innerHTML =
      "<p>Your class is not assigned yet.</p>";
  }

  loadStudentPanel(); // <-- load message card
}


  // ===== LOGOUT =====
  function logout() {
    currentStudent = null;
    document.getElementById('loginPanel').style.display = "block";
    document.getElementById('dashboard').style.display = "none";
    document.getElementById('studentID').value = "";
  }

  // ===== AUTH STATE LISTENER =====
  
  // ===== LOAD ATTENDANCE =====
  async function loadAttendance(className, studentUID) {
    const snap = await db.ref(`attendance/${className}`).once('value');
    const data = snap.val() || {};

    let totalDays = 0, present = 0, absent = 0;
    const monthlyCounts = {};

    Object.keys(data).forEach(date => {
      const status = data[date]?.[studentUID];
      if (!status) return;
      totalDays++;
      if (status === "Present") present++;
      if (status === "Absent") absent++;

      const monthKey = date.slice(0,7);
      if (!monthlyCounts[monthKey]) monthlyCounts[monthKey] = { present:0, total:0 };
      monthlyCounts[monthKey].total++;
      if (status === "Present") monthlyCounts[monthKey].present++;
    });

    document.getElementById('kpiPresent').textContent = present;
    document.getElementById('kpiAbsent').textContent = absent;
    document.getElementById('kpiPercent').textContent = totalDays ? Math.round((present/totalDays)*100) + "%" : "0%";

    const labels = Object.keys(monthlyCounts).sort();
    const dataPoints = labels.map(m => Math.round((monthlyCounts[m].present / monthlyCounts[m].total)*100));

    const ctx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[{ label:'% Attendance', data:dataPoints, backgroundColor:'rgba(54,162,235,0.6)' }] },
      options:{ responsive:true, scales:{y:{beginAtZero:true,max:100}} }
    });
  }

  // ===== LOAD HOMEWORK CALENDAR =====
  async function loadHomeworkCalendar(classId) {
  const cal = document.getElementById('calendarContainer');
  cal.innerHTML = "";

  const snap = await db.ref(`homework/${classId}`).once('value');
  const allHW = snap.val() || {};

  const today = new Date();
  const month = today.getMonth(); // 0-11
  const year = today.getFullYear();

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const totalDays = lastDay.getDate();

  let html = "";

  for (let d = 1; d <= totalDays; d++) {
    const dateObj = new Date(year, month, d);
    const dateStr = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD

    let classes = "calendar-day";
    if (dateStr === today.toISOString().split('T')[0]) classes += " today";
    if (allHW[dateStr]) classes += " hasHomework";

    html += `<div class="${classes}" onclick="showHomework('${classId}','${dateStr}')">${d}</div>`;
  }

  cal.innerHTML = html;
}


  // ===== SHOW HOMEWORK MODAL =====
// Show Homework Modal
// ===== HOMEWORK MODAL =====
async function showHomework(classId, date) {
  const modal = document.getElementById('homeworkModal');
  const modalList = document.getElementById('modalHomeworkList');
  document.getElementById('modalDate').textContent = date;

  const snap = await db.ref(`homework/${classId}/${date}`).once('value');
  const data = snap.val();

  let html = "<ul>";
  if (!data) html += "<li>No homework uploaded.</li>";
  else if (typeof data === "string") html += `<li>${data}</li>`;
  else
    Object.entries(data).forEach(([sub, hw]) => {
      html += `<li><strong>${sub}:</strong> ${hw}</li>`;
    });
  html += "</ul>";

  modalList.innerHTML = html;
  modal.classList.add('show');
}

// ===== CLOSE HOMEWORK MODAL =====
function closeHomeworkModal() {
  document.getElementById('homeworkModal').classList.remove('show');
}

// ===== GLOBAL VARIABLES =====
let studentMessageListener = null;
let currentStudentUid = null;
let lastTeacherUID = null; // store teacher to reply

// ===== OPEN STUDENT MESSAGE MODAL =====
function openStudentMessageModal(studentUid) {
  currentStudentUid = studentUid;
  const modal = document.getElementById('studentMessageModal');
  modal.classList.add('show');

  const container = document.getElementById('studentMessagesBox');
  container.innerHTML = "<p style='color:gray;text-align:center;'>Loading messages...</p>";

  // Remove previous listener
  if (studentMessageListener) db.ref(`messages/${studentUid}`).off('value', studentMessageListener);

  studentMessageListener = db.ref(`messages/${studentUid}`).on('value', async snap => {
    const teachersMessages = snap.val() || {};
    container.innerHTML = '';

    const teacherUIDs = Object.keys(teachersMessages);
    if (teacherUIDs.length === 0) {
      container.innerHTML = "<p style='color:gray;text-align:center;'>No messages yet.</p>";
      lastTeacherUID = null;
      return;
    }

    // Loop through each teacher
    for (const teacherUID of teacherUIDs) {
      const teacherSnap = await db.ref(`users/${teacherUID}`).once('value');
      const teacherData = teacherSnap.val();
      const teacherName = teacherData ? teacherData.name : 'Teacher';

      const messages = teachersMessages[teacherUID];
      const sortedTimestamps = Object.keys(messages).sort();

      // Display teacher header
      const header = document.createElement('div');
      header.style.textAlign = 'center';
      header.style.fontWeight = 'bold';
      header.style.color = 'var(--primary)';
      header.style.marginTop = '10px';
      header.textContent = teacherName;
      container.appendChild(header);

      // Display messages
      sortedTimestamps.forEach(ts => {
        const msg = messages[ts];
        const msgText = typeof msg === 'string' ? msg : msg.text;
        const senderRole = (typeof msg === 'object' && msg.senderRole) ? msg.senderRole : 'teacher';
        const senderName = (typeof msg === 'object' && msg.senderName) ? msg.senderName : teacherName;

        const div = document.createElement('div');
        div.style.marginBottom = '6px';
        div.style.padding = '6px 10px';
        div.style.borderRadius = '10px';
        div.style.maxWidth = '80%';
        div.style.wordBreak = 'break-word';
        div.style.background = senderRole === 'teacher' ? '#00bcd4' : '#e0e0e0';
        div.style.color = senderRole === 'teacher' ? '#fff' : '#000';
        div.style.alignSelf = senderRole === 'teacher' ? 'flex-start' : 'flex-end';
        div.innerHTML = `<strong>${senderName}:</strong> ${msgText}<br><small style="font-size:10px; opacity:0.7;">${new Date(parseInt(ts)).toLocaleString()}</small>`;
        container.appendChild(div);
      });

      // store last teacher UID for replying
      lastTeacherUID = teacherUID;
    }

    container.scrollTop = container.scrollHeight;
  });
}

// ===== CLOSE MESSAGE MODAL =====
function closeStudentMessageModal() {
  const modal = document.getElementById('studentMessageModal');
  modal.classList.remove('show');

  const container = document.getElementById('studentMessagesBox');
  container.innerHTML = '';

  if (studentMessageListener) db.ref(`messages/${currentStudentUid}`).off('value', studentMessageListener);
  lastTeacherUID = null;
}

// ===== SEND MESSAGE TO TEACHER =====
async function sendMessageToTeacher() {
  const input = document.getElementById('studentMessageInput');
  const text = input.value.trim();
  if (!text) return alert("Enter a message!");
  if (!currentStudentUid) return alert("Student UID missing!");
  if (!lastTeacherUID) return alert("No teacher to reply to yet!");

  const studentSnap = await db.ref(`users/${currentStudentUid}`).once('value');
  const studentData = studentSnap.val();

  const timestamp = Date.now();
  await db.ref(`messages/${currentStudentUid}/${lastTeacherUID}/${timestamp}`).set({
    text,
    senderRole: "student",
    senderName: studentData.name,
    senderUid: currentStudentUid,
    timestamp
  });

  input.value = '';
}

// ===== LOAD STUDENT PANEL =====
async function loadStudentPanel() {
  const container = document.getElementById('studentContainer');
  container.innerHTML = "Loadingâ€¦";

  const studentSnap = await db.ref(`users/${currentStudentUid}`).once("value");
  const studentData = studentSnap.val();

  container.innerHTML = `
    <div class="student-card" style="border:1px solid var(--border); padding:10px; border-radius:12px; margin-bottom:8px; background:var(--card)">
      <div class="row" style="display:flex; justify-content:space-between; align-items:center;">
        <div class="name">${studentData.name}</div>
        <button id="messageBtn" class="message-btn" title="Open Messages">ðŸ’¬</button>
      </div>
    </div>
  `;

  document.getElementById('messageBtn').addEventListener('click', () => {
    openStudentMessageModal(currentStudentUid);
  });

  // Attach send button event
  document.getElementById('sendStudentMsg').addEventListener('click', sendMessageToTeacher);
}


  </script>

</body>
</html>
