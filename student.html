<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1220; --surface:#151a2e; --surface-2:#1b2240; --text:#e9eefb; --muted:#a6b0cf;
    --primary:#00bcd4; --primary-2:#0097a7; --success:#21c064; --danger:#ff4f4f; --warn:#f0c419;
    --card:#151a2e; --border:#253058; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  [data-theme="light"]{
    --bg:#f6f8ff; --surface:#ffffff; --surface-2:#f3f6ff; --text:#0b1635; --muted:#47517a;
    --primary:#007c8a; --primary-2:#00a1b3; --success:#1e9c54; --danger:#e03b3b; --warn:#cc9c10;
    --card:#ffffff; --border:#e3e8ff; --shadow:0 8px 24px rgba(10,42,120,.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Navbar */
  .nav{
    position:sticky; top:0; z-index:50;
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; background:var(--surface); border-bottom:1px solid var(--border);
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:700}
  .brand .logo{
    width:32px; height:32px; display:grid; place-items:center; border-radius:10px;
    background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:white;
    box-shadow:0 6px 16px rgba(0, 188, 212, .25);
  }

  /* Layout */
  .wrap{padding:14px; max-width:1100px; margin:0 auto}

  /* Student info card */
  .profile{
    background:var(--card); border:1px solid var(--border); border-radius:14px;
    padding:16px; margin-top:14px; box-shadow:var(--shadow);
  }
  .profile h2{margin:0 0 6px; font-size:20px}
  .profile .meta{color:var(--muted); font-size:14px}

  /* Analytics header */
  .analytics{
    display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;
  }
  .kpi{
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
    display:flex; align-items:center; gap:12px; box-shadow:var(--shadow);
  }
  .kpi .icon{width:40px; height:40px; border-radius:10px; display:grid; place-items:center}
  .kpi .meta{line-height:1.2}
  .kpi .val{font-size:20px; font-weight:700}
  .icon.green{background:#163222; color:#7ff0a8}
  .icon.red{background:#3b1a1a; color:#ff8a8a}
  .icon.blue{background:#0f2730; color:#8de9f6}

  /* Section */
  .section{
    margin-top:14px; background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px;
  }
  .section h3{margin:0 0 10px 0; font-size:18px}

  /* Homework list */
  .homework-list{display:grid; gap:10px}
  .homework{
    border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--surface-2);
  }
  .homework .title{font-weight:600}
  .homework .date{font-size:12px; color:var(--muted); margin-top:4px}

  /* Graph */
  #attendanceChart{width:100%; height:300px; background:var(--surface-2); border-radius:12px; margin-top:10px}

  @media (min-width:680px){
    .analytics{grid-template-columns:repeat(3,1fr)}
  }



 .calendar-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
}
.calendar-day {
  padding: 10px;
  background: #f0f0f0;
  border-radius: 6px;
  text-align: center;
  cursor: pointer;
  transition: 0.2s;
}
.calendar-day:hover {
  background: #cfd8ff;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.5);
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 350px;
  max-height: 80%;
  overflow-y: auto;
  position: relative;
}
.modal-content .close {
  position: absolute;
  right: 10px;
  top: 10px;
  font-size: 20px;
  cursor: pointer;
}

</style>
</head>
<body>
  <div class="nav">
    <div class="brand"><div class="logo">ðŸŽ“</div> Student Panel</div>
  </div>

  <div class="wrap">

    <!-- LOGIN PANEL -->
    <div id="loginPanel" class="profile">
      <h2>Student Login</h2>
      <div>
        <input type="text" id="studentID" placeholder="Enter Your Student ID" 
               style="padding:8px; width:100%; margin:5px 0; border-radius:8px;">
        <button class="btn primary" onclick="loginStudent()">Login</button>
        <div id="loginError" style="color:var(--danger); margin-top:8px;"></div>
      </div>
    </div>

    <!-- DASHBOARD (hidden until login) -->
    <div id="dashboard" style="display:none;">
      <!-- Profile -->
      <div class="profile">
        <h2 id="studentName">Student Name</h2>
        <div class="meta">Class: <span id="studentClass">--</span></div>
        <div class="meta">Email: <span id="studentEmailShow">--</span></div>
        <button class="btn ghost" onclick="logout()">Logout</button>
      </div>

      <!-- KPIs -->
      <div class="analytics">
        <div class="kpi"><div class="icon green">âœ”</div>
          <div><div class="meta">Total Present</div><div id="kpiPresent" class="val">0</div></div>
        </div>
        <div class="kpi"><div class="icon red">âœ–</div>
          <div><div class="meta">Total Absent</div><div id="kpiAbsent" class="val">0</div></div>
        </div>
        <div class="kpi"><div class="icon blue">%</div>
          <div><div class="meta">Attendance %</div><div id="kpiPercent" class="val">0%</div></div>
        </div>
      </div>

      <!-- Attendance Graph -->
      <div class="section">
        <h3>Attendance This Month</h3>
        <canvas id="attendanceChart"></canvas>
      </div>

      <!-- Homework Section -->
      <div id="homeworkPanelStudent">
        <h3>ðŸ“… Homework Calendar</h3>
        <div id="calendarContainer"></div>
      </div>

      <!-- Homework Modal -->
      <div id="homeworkModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span class="close" onclick="closeHomeworkModal()">&times;</span>
          <h4 id="modalDate">Date</h4>
          <div id="modalHomeworkList"></div>
        </div>
      </div>
    </div>

  </div>

  <div class="footer-space"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
  // 1. Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCfffexgO1rf6m6EteNNtFb_kZnRqqTUBM",
    authDomain: "schoolmanagementsystem-32895.firebaseapp.com",
    databaseURL: "https://schoolmanagementsystem-32895-default-rtdb.firebaseio.com",
    projectId: "schoolmanagementsystem-32895",
    storageBucket: "schoolmanagementsystem-32895.appspot.com",
    messagingSenderId: "837516759841",
    appId: "1:837516759841:web:31d6666b15037082fa6460"
  };

  // 2. Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentStudent = null;

  // ===== LOGIN FUNCTION =====
  async function loginStudent() {
    const studentID = document.getElementById("studentID").value.trim();
    if (!studentID) {
      document.getElementById('loginError').textContent = "Enter your Student ID!";
      return;
    }

    try {
      const snap = await db.ref(`users/${studentID}`).once('value');
      const studentData = snap.val();

      if (!studentData || studentData.role !== "student") {
        document.getElementById('loginError').textContent = "Invalid Student ID!";
        return;
      }

      currentStudent = { uid: studentID, ...studentData };
      showDashboard(currentStudent);

    } catch (err) {
      document.getElementById('loginError').textContent = "Error: " + err.message;
    }
  }

  // ===== SHOW DASHBOARD =====
  function showDashboard(student) {
    document.getElementById('loginPanel').style.display = "none";
    document.getElementById('dashboard').style.display = "block";

    document.getElementById('studentName').textContent = student.name;
    document.getElementById('studentClass').textContent = student.class || "--";
    document.getElementById('studentEmailShow').textContent = student.email || "--";

    loadAttendance(student.class, student.uid);

    if (student.class) {
      loadHomeworkCalendar(student.class);
    } else {
      document.getElementById('calendarContainer').innerHTML =
        "<p>Your class is not assigned yet.</p>";
    }
  }

  // ===== LOGOUT =====
  function logout() {
    currentStudent = null;
    document.getElementById('loginPanel').style.display = "block";
    document.getElementById('dashboard').style.display = "none";
    document.getElementById('studentID').value = "";
  }

  // ===== AUTH STATE LISTENER =====
  auth.onAuthStateChanged(async (user) => {
    if (!user) return;

    const uid = user.uid;
    const snap = await db.ref(`users/${uid}`).once("value");
    const student = snap.val();

    if (!student || student.role !== "student") {
      alert("Access denied. Only students can log in here.");
      window.location.href = "index.html";
      return;
    }

    currentStudent = { uid, ...student };
    showDashboard(currentStudent);
  });

  // ===== LOAD ATTENDANCE =====
  async function loadAttendance(className, studentUID) {
    const snap = await db.ref(`attendance/${className}`).once('value');
    const data = snap.val() || {};

    let totalDays = 0, present = 0, absent = 0;
    const monthlyCounts = {};

    Object.keys(data).forEach(date => {
      const status = data[date]?.[studentUID];
      if (!status) return;
      totalDays++;
      if (status === "Present") present++;
      if (status === "Absent") absent++;

      const monthKey = date.slice(0,7);
      if (!monthlyCounts[monthKey]) monthlyCounts[monthKey] = { present:0, total:0 };
      monthlyCounts[monthKey].total++;
      if (status === "Present") monthlyCounts[monthKey].present++;
    });

    document.getElementById('kpiPresent').textContent = present;
    document.getElementById('kpiAbsent').textContent = absent;
    document.getElementById('kpiPercent').textContent = totalDays ? Math.round((present/totalDays)*100) + "%" : "0%";

    const labels = Object.keys(monthlyCounts).sort();
    const dataPoints = labels.map(m => Math.round((monthlyCounts[m].present / monthlyCounts[m].total)*100));

    const ctx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[{ label:'% Attendance', data:dataPoints, backgroundColor:'rgba(54,162,235,0.6)' }] },
      options:{ responsive:true, scales:{y:{beginAtZero:true,max:100}} }
    });
  }

  // ===== LOAD HOMEWORK CALENDAR =====
  async function loadHomeworkCalendar(classId) {
    const cal = document.getElementById('calendarContainer');
    const snap = await db.ref(`homework/${classId}`).once('value');
    const allHW = snap.val() || {};

    const dates = Object.keys(allHW).sort().reverse();
    if (!dates.length) {
      cal.innerHTML = "<p>No homework uploaded yet.</p>";
      return;
    }

    let html = "<div class='calendar-grid'>";
    dates.forEach(date => {
      html += `<div class="calendar-day" onclick="showHomework('${classId}','${date}')">${date}</div>`;
    });
    html += "</div>";
    cal.innerHTML = html;
  }

  // ===== SHOW HOMEWORK MODAL =====
  async function showHomework(classId, date) {
    const modal = document.getElementById('homeworkModal');
    const modalList = document.getElementById('modalHomeworkList');
    document.getElementById('modalDate').textContent = date;

    const snap = await db.ref(`homework/${classId}/${date}`).once('value');
    const data = snap.val();

    let html = "<ul>";
    if (!data) html += "<li>No homework uploaded.</li>";
    else if (typeof data === "string") html += `<li>${data}</li>`;
    else Object.entries(data).forEach(([sub, hw]) => {
      html += `<li><strong>${sub}:</strong> ${hw}</li>`;
    });
    html += "</ul>";

    modalList.innerHTML = html;
    modal.style.display = "flex";
  }

  function closeHomeworkModal() {
    document.getElementById('homeworkModal').style.display = "none";
  }

  </script>

</body>
</html>
