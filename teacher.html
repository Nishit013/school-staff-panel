<!DOCTYPE html>
<html lang="en">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f4f4;
      --sidebar: #ffffff;
      --card: #ffffff;
      --text: #111111;
      --primary: #00bcd4;
      --accent: #0097a7;
      --success: #21c064;
      --danger: #ff4f4f;
    }

    [data-theme="dark"] {
      --bg: #0f0f0f;
      --sidebar: #141414;
      --card: #1a1a1a;
      --text: #f0f0f0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
    }

    body {
      display: flex;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: var(--sidebar);
      padding: 20px;
      box-shadow: 2px 0 12px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
    }
    .sidebar h2 {
      margin-bottom: 20px;
      color: var(--primary);
    }
    .sidebar a {
      display: block;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      text-decoration: none;
      color: var(--text);
      transition: 0.3s;
    }
    .sidebar a:hover {
      background: var(--primary);
      color: #fff;
    }
    .theme-toggle {
      margin-top: auto;
      padding: 8px 12px;
      border: 2px solid var(--primary);
      border-radius: 8px;
      background: transparent;
      color: var(--primary);
      cursor: pointer;
    }

    /* Main */
    .main {
      margin-left: 240px;
      padding: 20px;
      flex: 1;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 16px;
    }

    .card {
      background: var(--card);
      padding: 20px;
      border-radius: 14px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: 0.3s;
    }
    .card:hover {
      transform: translateY(-2px);
    }

    button {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      transform: scale(1.05);
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #aaa;
      background: transparent;
      color: var(--text);
    }

    /* Student Grid */
    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      max-height: 420px;
      overflow-y: auto;
    }
    .student-card {
      background: var(--sidebar);
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .student-card .name {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .progress-bar {
      height: 8px;
      background: #ddd;
      border-radius: 6px;
      overflow: hidden;
      margin: 6px 0;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      transition: width 0.8s;
    }
    .progress-fill.present {
      background: var(--success);
    }
    .progress-fill.absent {
      background: var(--danger);
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        width: 200px;
        left: -200px;
        transition: left 0.3s;
      }
      .sidebar.open {
        left: 0;
      }
      .main {
        margin-left: 0;
        padding: 16px;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>üìö Teacher</h2>
    <a href="#class">üè´ Classes</a>
    <a href="#students">üë• Students</a>
    <a href="#homework">‚úèÔ∏è Homework</a>
    <a href="#analytics">üìä Analytics</a>
    <button class="theme-toggle" onclick="toggleTheme()">üåô Theme</button>
  </div>

  <!-- Main Content -->
  <div class="main">
    <h1>üë©‚Äçüè´ Teacher Dashboard</h1>

    <div class="card" id="class">
      <h3>üè´ Class Manager</h3>
      <label>Add Class:</label>
      <input type="text" placeholder="e.g. 6B" />
      <button>Create</button>
    </div>

    <div class="card" id="students">
      <h3>üë• Student List</h3>
      <input type="date" />
      <input type="text" placeholder="üîç Search student..." />
      <div class="student-grid">
        <div class="student-card">
          <div class="name">John Doe</div>
          <div class="progress-bar"><div class="progress-fill present" style="width: 80%"></div></div>
          <small>Attendance: 80%</small>
        </div>
        <div class="student-card">
          <div class="name">Jane Smith</div>
          <div class="progress-bar"><div class="progress-fill present" style="width: 95%"></div></div>
          <small>Attendance: 95%</small>
        </div>
      </div>
    </div>

    <div class="card" id="homework">
      <h3>‚úèÔ∏è Upload Homework</h3>
      <textarea rows="4" placeholder="Write homework here..."></textarea>
      <button>Upload</button>
    </div>
  </div>

  <script>
    function toggleTheme(){
      document.body.dataset.theme =
        document.body.dataset.theme === "dark" ? "light" : "dark";
    }
  </script>


  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCfffexgO1rf6m6EteNNtFb_kZnRqqTUBM",
      authDomain: "schoolmanagementsystem-32895.firebaseapp.com",
      databaseURL: "https://schoolmanagementsystem-32895-default-rtdb.firebaseio.com",
      projectId: "schoolmanagementsystem-32895",
      storageBucket: "schoolmanagementsystem-32895.appspot.com",
      messagingSenderId: "837516759841",
      appId: "1:837516759841:web:31d6666b15037082fa6460"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let assignedClass = "";

    auth.onAuthStateChanged(user => {
      if (user) {
        const uid = user.uid;
        db.ref("users/" + uid).once("value").then(snapshot => {
          const data = snapshot.val();
          if (!data || data.role !== "teacher") {
            alert("Access denied.");
            window.location.href = "index.html";
            return;
          }

          document.getElementById("teacherName").innerText = data.name || "(unknown)";

          db.ref("classes").orderByChild("createdBy").equalTo(uid).once("value").then(classesSnap => {
            const allClasses = classesSnap.val() || {};
            const classNames = Object.keys(allClasses);
            const selector = document.getElementById("classSelector");
            selector.innerHTML = `<option value="">-- Select --</option>`;

            if (classNames.length > 0) {
              classNames.forEach(classId => {
                const option = document.createElement("option");
                option.value = classId;
                option.textContent = classId;
                selector.appendChild(option);
              });

              assignedClass = classNames[classNames.length - 1];
              selector.value = assignedClass;
              document.getElementById("className").innerText = assignedClass;
              loadStudents(assignedClass);
            } else {
              document.getElementById("className").innerText = "None yet";
              document.getElementById("studentContainer").innerHTML = "<p>No class found yet. Please create one.</p>";
            }
          });
        });
      } else {
        window.location.href = "index.html";
      }
    });

    function onClassSelect(classId) {
      if (!classId) return;
      assignedClass = classId;
      document.getElementById("className").innerText = classId;
      loadStudents(classId);
    }

    
  // Your existing firebaseConfig, firebase.initializeApp, auth and db remain same
  // Continue after auth.onAuthStateChanged logic

  function loadStudents(classId) {
  const container = document.getElementById("studentContainer");
  container.innerHTML = "<p>Loading students...</p>";

  const selectedDate = document.getElementById("attendanceDate")?.value || new Date().toISOString().split('T')[0];

  db.ref("classes/" + classId + "/students").once("value").then(snapshot => {
    const students = snapshot.val();
    if (!students) {
      container.innerHTML = "<p>No students found in this class.</p>";
      return;
    }

    container.innerHTML = "";
    window.studentCards = [];

    db.ref(`attendance/${classId}/${selectedDate}`).once("value").then(daySnap => {
      const attendanceToday = daySnap.val() || {};

      Object.entries(students).forEach(([id, name]) => {
        const card = document.createElement("div");
        card.className = "student-card";
        card.setAttribute("data-name", name.toLowerCase());

        // Count all-time attendance for analytics
        db.ref(`attendance/${classId}`).once("value").then(attSnap => {
          const allDays = attSnap.val() || {};
          let presentCount = 0, absentCount = 0;

          Object.values(allDays).forEach(day => {
            if (day[id] === "Present") presentCount++;
            if (day[id] === "Absent") absentCount++;
          });

          const statusToday = attendanceToday[id] || "Not Marked";

         card.innerHTML = `
  <div class="name">${name}</div>
  <div class="analytics">
    üìÖ Date: ${selectedDate}<br>
    üü° Today: <strong>${statusToday}</strong><br>
    ‚úÖ Present: ${presentCount} | ‚ùå Absent: ${absentCount}
    
    <div class="bar-label">‚úÖ Present %</div>
    <div class="progress-bar">
      <div class="progress-fill present" style="width: 0%;"></div>
    </div>
    <div class="bar-label">‚ùå Absent %</div>
    <div class="progress-bar">
      <div class="progress-fill absent" style="width: 0%;"></div>
    </div>
  </div>
  <div class="actions">
    <button onclick="markAttendance('${id}', '${name}', 'Present')">Present</button>
    <button onclick="markAttendance('${id}', '${name}', 'Absent')">Absent</button>
    <button style="background-color:#e74c3c" onclick="deleteStudent('${id}', '${name}')">Delete</button>
  </div>
`;
setTimeout(() => {
  const totalDays = presentCount + absentCount || 1;
  const presentPercent = (presentCount / totalDays) * 100;
  const absentPercent = (absentCount / totalDays) * 100;

  card.querySelector(".progress-fill.present").style.width = `${presentPercent}%`;
  card.querySelector(".progress-fill.absent").style.width = `${absentPercent}%`;
}, 100);

          studentCards.push(card);
          container.appendChild(card);
        });
      });
    });
  });
}


  function markAttendance(studentId, studentName, status) {
  const today = new Date().toISOString().split('T')[0];
  const path = `attendance/${assignedClass}/${today}/${studentId}`;

  db.ref(path).once("value").then(snapshot => {
    const currentStatus = snapshot.val();

    if (currentStatus === status) {
      // Already marked with same status ‚Äî no need to update
      console.log(`${studentName} already marked as ${status}`);
      return;
    }

    db.ref(path).set(status)
      .then(() => {
        // Silent update ‚Äî no alert
        loadStudents(assignedClass); // Refresh UI
      })
      .catch(err => {
        console.error("Error updating attendance:", err.message);
      });
  });
}


  function deleteStudent(studentId, studentName) {
    if (confirm(`Are you sure you want to remove ${studentName}?`)) {
      db.ref(`classes/${assignedClass}/students/${studentId}`).remove()
        .then(() => {
          alert(`${studentName} deleted`);
          loadStudents(assignedClass);
        });
    }
  }

  function downloadCSV() {
    db.ref("classes/" + assignedClass + "/students").once("value").then(snapshot => {
      const students = snapshot.val();
      if (!students) return;

      let csv = "Student ID,Student Name\n";
      for (const [id, name] of Object.entries(students)) {
        csv += `${id},${name}\n`;
      }

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `${assignedClass}_students.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }



    function uploadHomework() {
      const homework = document.getElementById("homeworkText").value.trim();
      const statusText = document.getElementById("homeworkStatus");
      if (!homework) {
        statusText.style.color = "red";
        statusText.textContent = "Please enter homework.";
        return;
      }

      const today = new Date().toISOString().split('T')[0];
      db.ref(`homework/${assignedClass}/${today}`).set(homework)
        .then(() => {
          statusText.style.color = "lightgreen";
          statusText.textContent = "Homework uploaded successfully.";
          document.getElementById("homeworkText").value = "";
        });
    }

    function addNewClass() {
      const classInput = document.getElementById("newClassInput").value.trim().toUpperCase();
      const status = document.getElementById("classStatus");
      status.textContent = "";

      if (!classInput) {
        status.style.color = "red";
        status.textContent = "Please enter a class name.";
        return;
      }

      const teacherUID = firebase.auth().currentUser.uid;

      db.ref("classes/" + classInput).set({
        createdBy: teacherUID,
        students: {}
      })
      .then(() => {
        status.style.color = "lightgreen";
        status.textContent = `Class ${classInput} created successfully.`;
        document.getElementById("newClassInput").value = "";

        const selector = document.getElementById("classSelector");
        const option = document.createElement("option");
        option.value = classInput;
        option.textContent = classInput;
        selector.appendChild(option);
        selector.value = classInput;

        assignedClass = classInput;
        document.getElementById("className").innerText = assignedClass;
        loadStudents(assignedClass);
      })
      .catch(err => {
        status.style.color = "red";
        status.textContent = "Error: " + err.message;
      });
    }

    function addStudent() {
      const classId = document.getElementById("classForStudent").value.trim().toUpperCase();
      const studentName = document.getElementById("studentNameInput").value.trim();
      const status = document.getElementById("studentStatus");
      status.textContent = "";

      if (!classId || !studentName) {
        status.style.color = "red";
        status.textContent = "Please enter both class and student name.";
        return;
      }

      const studentId = "stu" + Date.now();

      db.ref(`classes/${classId}/students/${studentId}`).set(studentName)
        .then(() => {
          status.style.color = "lightgreen";
          status.textContent = `Student '${studentName}' added to class ${classId}.`;
          document.getElementById("studentNameInput").value = "";
          if (classId === assignedClass) loadStudents(assignedClass);
        })
        .catch(err => {
          status.style.color = "red";
          status.textContent = "Error: " + err.message;
        });
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "./index.html";
      });
    }
    // üîÑ Theme toggle logic
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}

// Load saved theme on page load
window.onload = () => {
  const saved = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
};
function filterStudents() {
  const keyword = document.getElementById("studentSearch").value.toLowerCase().trim();
  const container = document.getElementById("studentContainer");

  container.innerHTML = ""; // clear all
  studentCards.forEach(card => {
    const name = card.getAttribute("data-name");
    if (name.includes(keyword)) {
      container.appendChild(card);
    }
  });
}

  </script>
</body>
</html>
