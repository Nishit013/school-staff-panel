<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Teacher Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1220; --surface:#151a2e; --surface-2:#1b2240; --text:#e9eefb; --muted:#a6b0cf;
    --primary:#00bcd4; --primary-2:#0097a7; --success:#21c064; --danger:#ff4f4f; --warn:#f0c419;
    --card:#151a2e; --border:#253058; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  [data-theme="light"]{
    --bg:#f6f8ff; --surface:#ffffff; --surface-2:#f3f6ff; --text:#0b1635; --muted:#47517a;
    --primary:#007c8a; --primary-2:#00a1b3; --success:#1e9c54; --danger:#e03b3b; --warn:#cc9c10;
    --card:#ffffff; --border:#e3e8ff; --shadow:0 8px 24px rgba(10,42,120,.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Navbar */
  .nav{
    position:sticky; top:0; z-index:50;
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; background:var(--surface); border-bottom:1px solid var(--border);
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:700}
  .brand .logo{
    width:32px; height:32px; display:grid; place-items:center; border-radius:10px;
    background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:white;
    box-shadow:0 6px 16px rgba(0, 188, 212, .25);
  }
  .nav-actions{display:flex; align-items:center; gap:8px}
  .btn, .chip{
    border:1px solid var(--border); background:var(--surface-2); color:var(--text);
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    transition:.2s transform, .2s background, .2s border-color; box-shadow:var(--shadow);
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-2)); border-color:transparent; color:white}
  .btn.danger{background:var(--danger); color:white; border-color:transparent}
  .btn.ghost{background:transparent}

  /* Layout */
  .wrap{padding:14px; max-width:1100px; margin:0 auto}

  /* Analytics header */
  .analytics{
    display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;
  }
  .kpi{
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
    display:flex; align-items:center; gap:12px; box-shadow:var(--shadow);
  }
  .kpi .icon{width:40px; height:40px; border-radius:10px; display:grid; place-items:center}
  .kpi .meta{line-height:1.2}
  .kpi .val{font-size:20px; font-weight:700}
  .icon.green{background:#163222; color:#7ff0a8}
  .icon.red{background:#3b1a1a; color:#ff8a8a}
  .icon.blue{background:#0f2730; color:#8de9f6}

  /* Floating class summary */
  .summary{
    position:sticky; top:64px; z-index:1;
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
    margin-top:10px; box-shadow:var(--shadow);
  }
  .summary-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .mini{
    background:var(--surface-2); border:1px solid var(--border); border-radius:12px; padding:10px;
  }
  .spark{width:100%; height:40px}

  /* Controls */
  .controls{
    margin-top:14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px;
  }
  .select, .input{
    flex:1 1 180px; display:flex; align-items:center; gap:8px;
    border:1px solid var(--border); background:var(--surface-2); padding:10px 12px; border-radius:12px;
  }
  .select select, .input input{
    width:100%; border:none; outline:none; background:transparent; color:var(--text); font-size:14px;
  }

  /* Student list */
  .section{
    margin-top:14px; background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px;
  }
  .section h3{margin:0 0 10px 0; font-size:18px}
  .list{display:grid; gap:10px}
  .student{
    border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--surface-2);
    display:grid; gap:10px;
  }
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  .name{font-weight:700}
  .stats{font-size:12px; color:var(--muted)}
  .actions{display:flex; gap:8px}
  .actions .btn{padding:8px 10px; border-radius:8px; box-shadow:none}
  .actions .present{background:var(--success); color:white; border-color:transparent}
  .actions .absent{background:var(--danger); color:white; border-color:transparent}
  .actions .confirm{background:var(--primary); color:white; border-color:transparent}

  /* Progress bars */
  .bar-label{font-size:12px; color:var(--muted); margin:2px 0 4px}
  .bar{height:10px; background:#1f274b; border-radius:6px; overflow:hidden}
  .fill{height:100%; width:0%; transition:width .8s ease; border-radius:6px}
  .fill.present{background:var(--success)}
  .fill.absent{background:var(--danger)}

  /* Footer */
  .footer-space{height:18px}

  /* Mobile first + small tablet */
  @media (min-width:680px){
    .analytics{grid-template-columns:repeat(3,1fr)}
    .summary-grid{grid-template-columns:repeat(4,1fr)}
    .list{grid-template-columns:1fr 1fr}
  }
  @media (min-width:980px){
    .list{grid-template-columns:1fr 1fr 1fr}
  }


  .btn.selected {
  background: #3b82f6;  /* blue background */
  color: white;
  font-weight: bold;
}



/* Homework Card Styles */
.subject-homework {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-shadow: var(--shadow);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.subject-homework:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.4);
}

.subject-homework h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

.subject-homework textarea {
  width: 100%;
  min-height: 80px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
  font-size: 14px;
  resize: vertical;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.subject-homework textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 8px rgba(0, 188, 212, 0.4);
}

.subject-homework button {
  align-self: flex-end;
  padding: 8px 14px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
  color: white;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: transform 0.2s;
}

.subject-homework button:hover {
  transform: translateY(-2px);
}



/* ===== Message Modal ===== */
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none; /* hidden by default */
  justify-content: center; align-items: center;
  z-index: 9999;
}

.modal-content {
  background: var(--surface);
  color: var(--text);
  padding: 20px;
  border-radius: 12px;
  width: 400px;
  max-width: 90%;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  position: relative;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  transition: background 0.3s, color 0.3s;
}

.close {
  position: absolute;
  top: 10px; right: 14px;
  cursor: pointer;
  font-size: 22px;
  color: var(--text);
}

.messages-box {
  flex: 1;
  overflow-y: auto;
  margin-top: 15px;
  padding: 10px;
  border-radius: 10px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  scroll-behavior: smooth;
}

.empty-msg {
  text-align: center;
  color: var(--muted);
  font-size: 14px;
  opacity: 0.7;
}

.message-input {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.message-input input {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
  outline: none;
  font-size: 14px;
}

.message-input button {
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s background;
}

.message-input button:hover {
  background: var(--primary-2);
}

/* ===== Student Card (fix for theme) ===== */
.student {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  margin: 10px 0;
  background: var(--surface-2);
  color: var(--text);
  position: relative;
  box-shadow: var(--shadow);
  transition: background 0.3s, color 0.3s;
}

.student .row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}

.student .actions button {
  margin-right: 5px;
}

.student .message-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  cursor: pointer;
  color: var(--primary);
}

/* Progress bar theme fix */
.bar {
  width: 100%;
  height: 8px;
  background: var(--surface);
  border-radius: 4px;
  margin-bottom: 5px;
  overflow: hidden;
}
.fill.present {
  height: 100%;
  background: var(--success);
  width: 0;
  transition: width 0.5s;
}
.fill.absent {
  height: 100%;
  background: var(--danger);
  width: 0;
  transition: width 0.5s;
}


</style>
</head>
<body>

  <!-- NAV -->
  <div class="nav">
    <div class="brand">
      <div class="logo">üìö</div>
      <div>Teacher Dashboard</div>
    </div>
    <div class="nav-actions">
      <button class="btn ghost" id="themeToggle" title="Toggle theme">üåì</button>
      <div class="chip" id="teacherChip">üë©‚Äçüè´ <span id="teacherName">‚Äî</span></div>
      <button class="btn danger" onclick="logoutTeacher()">Logout</button>
    </div>
  </div>

  <div class="wrap">

    <!-- KPIs -->
    <div class="analytics">
      <div class="kpi">
        <div class="icon green">‚úÖ</div>
        <div class="meta">
          <div class="label">Present (Today)</div>
          <div class="val" id="kpiPresent">0</div>
        </div>
      </div>
      <div class="kpi">
        <div class="icon red">‚ùå</div>
        <div class="meta">
          <div class="label">Absent (Today)</div>
          <div class="val" id="kpiAbsent">0</div>
        </div>
      </div>
      <div class="kpi">
        <div class="icon blue">üìä</div>
        <div class="meta">
          <div class="label">Attendance % (Today)</div>
          <div class="val" id="kpiPercent">0%</div>
        </div>
      </div>
    </div>

    <!-- Floating summary -->
    <div class="summary">
      <div class="row" style="margin-bottom:8px">
        <div><strong>Class:</strong> <span id="className">‚Äî</span></div>
        <div><strong>Date:</strong> <input type="date" id="attendanceDate" onchange="reloadAll()" /></div>
      </div>
      <div class="summary-grid">
        <div class="mini"><div>Total Students</div><div style="font-size:20px;font-weight:700" id="sumTotal">0</div></div>
        <div class="mini"><div>Marked Today</div><div style="font-size:20px;font-weight:700" id="sumMarked">0</div></div>
        <div class="mini"><div>Present %</div><div style="font-size:20px;font-weight:700" id="sumPercent">0%</div></div>
        <div class="mini"><div>7-Day Trend</div><canvas id="trend" class="spark"></canvas></div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="select">
        <span>üìÇ Class</span>
        <select id="classSelector" onchange="onClassSelect(this.value)">
          <option value="">Loading‚Ä¶</option>
        </select>
      </div>
      <div class="input">
        <span>üîç</span>
        <input id="studentSearch" placeholder="Search student‚Ä¶" oninput="filterStudents()">
      </div>
      <button class="btn primary" onclick="confirmAll()" title="Save all pending marks">‚úÖ Confirm All</button>
      <button class="btn" onclick="downloadCSV()">‚¨áÔ∏è Export CSV</button>
    </div>


    <!-- Add Students -->
<div class="section">
  <h3>‚ûï Add Student</h3>
  <div class="row">
    <input id="newStudentName" placeholder="Enter student name"
      style="flex:1;border:1px solid var(--border);background:var(--surface-2);color:var(--text);border-radius:12px;padding:10px" />
    <button class="btn primary" onclick="addStudent()">Add</button>
  </div>
  <div id="addStudentStatus" style="margin-top:6px;color:var(--muted);font-size:13px"></div>
</div>



    <!-- Students -->
    <div class="section">
      <h3>Attendance ‚Äî Students</h3>
      <div id="studentContainer" class="list">Loading‚Ä¶</div>
    </div>

    <!-- Homework (kept simple) -->
    <div id="homeworkPanel" class="panel">
  <h3>Add Homework</h3>
  <div id="subjectHomeworkContainer"></div>
</div>


<div id="teacherMessageModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeTeacherMessageModal()">&times;</span>
    <h3>Message to <span id="modalStudentName"></span></h3>
    <div id="teacherMessageHistory" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:5px;">
      <!-- messages will load here -->
    </div>
    <textarea id="teacherMessageInput" placeholder="Type message" style="width:100%; height:50px; margin-top:10px;"></textarea>
    <button onclick="sendTeacherMessage()" style="margin-top:5px;">Send</button>
  </div>
</div>

    <div class="footer-space"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ==== Firebase config (yours) ====
    const firebaseConfig = {
      apiKey: "AIzaSyCfffexgO1rf6m6EteNNtFb_kZnRqqTUBM",
      authDomain: "schoolmanagementsystem-32895.firebaseapp.com",
      databaseURL: "https://schoolmanagementsystem-32895-default-rtdb.firebaseio.com",
      projectId: "schoolmanagementsystem-32895",
      storageBucket: "schoolmanagementsystem-32895.appspot.com",
      messagingSenderId: "837516759841",
      appId: "1:837516759841:web:31d6666b15037082fa6460"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ==== State ====
    let assignedClass = "";
    let attendanceListener = null;
    let tempAttendance = {}; // { studentId: 'Present'|'Absent' }
    let studentCards = [];   // for filtering
    let allStudentsMap = {}; // { id: name } cache for class
    const todayISO = () => new Date().toISOString().split('T')[0];

    // ==== Theme toggle ====
    const themeToggle = document.getElementById('themeToggle');
    const setTheme = (t)=>document.documentElement.setAttribute('data-theme', t);
    setTheme(localStorage.getItem('theme') || 'dark');
    themeToggle.onclick = ()=>{
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      setTheme(next); localStorage.setItem('theme', next);
    };

    // ==== Auth & bootstrap ====
// Create named app instance for Teacher Panel
const teacherApp = firebase.initializeApp(firebaseConfig, "teacherPanel");
const teacherAuth = teacherApp.auth();
const teacherDb = teacherApp.database();

// Protect teacher panel
teacherAuth.onAuthStateChanged(async user => {
  if (!user) {
    window.location.href = "index.html"; // teacher login
    return;
  }

  const snap = await teacherDb.ref("users/" + user.uid).once("value");
  const u = snap.val();
  if (!u || u.role !== "teacher") {
    alert("Access denied.");
    window.location.href = "index.html";
    return;
  }

  document.getElementById("teacherName").textContent = u.name || "(unknown)";

  // Set default date = today
  const dateEl = document.getElementById('attendanceDate');
  dateEl.value = todayISO();

  // Load teacher's classes
  const classesSnap = await teacherDb.ref("classes").once("value"); // <-- use teacherDb
  const classes = classesSnap.val() || {};
  const classNames = Object.keys(classes);
  const sel = document.getElementById('classSelector');
  sel.innerHTML = classNames.length ? '<option value="">‚Äî Select ‚Äî</option>' : '<option value="">No classes yet</option>';
  classNames.forEach(cid => {
    const o = document.createElement('option'); 
    o.value = cid; 
    o.textContent = cid; 
    sel.appendChild(o);
  });

  // Auto-select last class (if any)
  if(classNames.length){
    assignedClass = classNames[classNames.length-1];
    sel.value = assignedClass;
    document.getElementById('className').textContent = assignedClass;

    await loadStudents(assignedClass);       // make sure this function uses teacherDb
    attachAttendanceListener();              // live updates for the date
    refreshAnalytics();                      // fill KPI + summary + sparkline
    await loadSubjectsForHomework();         // load homework subjects automatically
  } else {
    document.getElementById('studentContainer').innerHTML = '<div class="mini">Create a class to begin.</div>';
  }
});

// Teacher logout
function logoutTeacher() {
  teacherAuth.signOut().then(() => {
    location.href = "./index.html"; // redirect only teacher panel
  });
}


    // ==== Live listener for selected date ====
    function attachAttendanceListener(){
      if(attendanceListener){ attendanceListener.off(); attendanceListener=null; }
      if(!assignedClass) return;
      const d = selectedDate();
      attendanceListener = db.ref(`attendance/${assignedClass}/${d}`);
      attendanceListener.on('value', ()=>{ refreshAnalytics(); /* live KPI */ loadStudents(assignedClass); });
    }

    function selectedDate(){
      return document.getElementById('attendanceDate')?.value || todayISO();
    }
    function reloadAll(){
      attachAttendanceListener();
      refreshAnalytics();
      loadStudents(assignedClass);
    }

    // ==== Class select ====
    async function onClassSelect(classId){
      if(!classId) return;
      assignedClass = classId;
      document.getElementById('className').textContent = classId;
      tempAttendance = {};
      await loadStudents(classId);
      attachAttendanceListener();
      refreshAnalytics();
    }

    // ==== Load students + build cards ====
    async function loadStudents(classId) {
  const container = document.getElementById('studentContainer');
  container.innerHTML = "Loading‚Ä¶";
  studentCards = [];

  if (!classId) { 
    container.innerHTML = "Select a class."; 
    return; 
  }

  const studentsSnap = await db.ref(`classes/${classId}/students`).once("value");
  const students = studentsSnap.val();
  allStudentsMap = students || {};

  if (!students) { 
    container.innerHTML = "No students in this class."; 
    return; 
  }

  const d = selectedDate();
  const todaySnap = await db.ref(`attendance/${classId}/${d}`).once("value");
  const attendanceToday = todaySnap.val() || {};

  const allDaysSnap = await db.ref(`attendance/${classId}`).once("value");
  const allDays = allDaysSnap.val() || {};

  container.innerHTML = "";
  studentCards = [];

  for (const [id, name] of Object.entries(students)) {
    let presentCount = 0, absentCount = 0;

    Object.values(allDays).forEach(day => {
      if (day[id] === "Present") presentCount++;
      if (day[id] === "Absent") absentCount++;
    });

    let statusToday = tempAttendance[id] || attendanceToday[id] || "Not Marked";

    const card = document.createElement('div');
    card.className = "student";
    card.setAttribute("data-id", id);
    card.setAttribute("data-name", name.toLowerCase());

    card.innerHTML = `
      <div class="row">
        <div class="name">${name}</div>
        <div class="stats">
          üìÖ ${d} ‚Ä¢ Today: <strong>${statusToday}</strong> ‚Ä¢
          ‚úÖ ${presentCount} | ‚ùå ${absentCount}
        </div>
        <div class="message-btn" onclick="openTeacherMessageModal('${id}','${name}')">üí¨</div>
      </div>
      <div>
        <div class="bar-label">‚úÖ Present %</div>
        <div class="bar"><div class="fill present"></div></div>
        <div class="bar-label">‚ùå Absent %</div>
        <div class="bar"><div class="fill absent"></div></div>
      </div>
      <div class="row">
        <div class="actions">
          <button class="btn present ${tempAttendance[id]==='Present' ? 'selected' : ''}" 
            onclick="stageAttendance('${id}','${name}','Present')">Present</button>
          <button class="btn absent ${tempAttendance[id]==='Absent' ? 'selected' : ''}" 
            onclick="stageAttendance('${id}','${name}','Absent')">Absent</button>
          ${tempAttendance[id] ? `<button class="btn confirm" onclick="confirmAttendance('${id}','${name}')">‚úÖ Confirm</button>` : ``}
        </div>
        <button class="btn ghost" onclick="deleteStudent('${id}','${name}')">üóëÔ∏è Delete</button>
      </div>
    `;

    // Animate bars
    setTimeout(() => {
      const total = presentCount + absentCount || 1;
      card.querySelector('.fill.present').style.width = `${(presentCount / total) * 100}%`;
      card.querySelector('.fill.absent').style.width = `${(absentCount / total) * 100}%`;
    }, 40);

    container.appendChild(card);
    studentCards.push(card);
  }

  filterStudents(); // apply search filter
}



    // Example function to add student
function addStudent() {
  const name = document.getElementById('newStudentName').value.trim();
  const s = document.getElementById('addStudentStatus');

  if (!assignedClass) {
    s.style.color = 'var(--danger)';
    s.textContent = 'Please select a class first.';
    return;
  }
  if (!name) {
    s.style.color = 'var(--danger)';
    s.textContent = 'Enter a valid student name.';
    return;
  }

  // Generate unique ID (Firebase push key)
  const newId = db.ref(`classes/${assignedClass}/students`).push().key;

  // Add student to class node
  db.ref(`classes/${assignedClass}/students/${newId}`).set(name)
    .then(() => {
      // ‚úÖ Add student to users node automatically
      return db.ref(`users/${newId}`).set({
        name: name,
        class: assignedClass,
        role: "student"
      });
    })
    .then(() => {
      s.style.color = 'var(--success)';
      s.textContent = `Added ${name} ‚úÖ | Student ID: ${newId}`;
      document.getElementById('newStudentName').value = "";
      loadStudents(assignedClass); // refresh list
      refreshAnalytics();
    })
    .catch(err => {
      s.style.color = 'var(--danger)';
      s.textContent = 'Error: ' + err.message;
    });
}






    // ==== Staging + confirm workflow ====
   function stageAttendance(studentId, studentName, status) {
  const d = selectedDate();

  db.ref(`attendance/${assignedClass}/${d}/${studentId}`).once('value').then(s => {
    if (s.exists()) {
      alert("Attendance already confirmed for this student.");
      return;
    }

    tempAttendance[studentId] = status;

    // Inline update instead of reloading all
    const card = studentCards.find(c => c.getAttribute("data-id") === studentId);
    if (card) {
      card.querySelector(".stats strong").textContent = `${status} (Pending)`;

      card.querySelectorAll(".btn.present, .btn.absent")
          .forEach(btn => btn.classList.remove("selected"));
      card.querySelector(`.btn.${status.toLowerCase()}`).classList.add("selected");

      // add confirm button if missing
      if (!card.querySelector(".btn.confirm")) {
        const confirmBtn = document.createElement("button");
        confirmBtn.className = "btn confirm";
        confirmBtn.textContent = "‚úÖ Confirm";
        confirmBtn.onclick = () => confirmAttendance(studentId, studentName);
        card.querySelector(".actions").appendChild(confirmBtn);
      }
    }

    updateConfirmAllButton();
  });
}



function cancelPending(studentId) {
  delete tempAttendance[studentId];
  loadStudents(assignedClass); 
  updateConfirmAllButton();
}


  function confirmAttendance(studentId, studentName) {
  const d = selectedDate();
  const status = tempAttendance[studentId];
  if (!status) return;

  db.ref(`attendance/${assignedClass}/${d}/${studentId}`).set(status)
    .then(() => {
      delete tempAttendance[studentId];

      // Inline update only
      const card = studentCards.find(c => c.getAttribute("data-id") === studentId);
      if (card) {
        card.querySelector(".stats strong").textContent = status;
        const confirmBtn = card.querySelector(".btn.confirm");
        if (confirmBtn) confirmBtn.remove();
        card.querySelectorAll(".btn.present, .btn.absent")
            .forEach(btn => btn.classList.remove("selected"));
      }

      refreshAnalytics();
      updateConfirmAllButton();
    });
}


   function confirmAll() {
  const d = selectedDate();
  const updates = {};

  Object.entries(tempAttendance).forEach(([sid, st]) => {
    updates[`attendance/${assignedClass}/${d}/${sid}`] = st;
  });

  if (Object.keys(updates).length === 0) {
    alert("No staged attendance to confirm.");
    return;
  }

  db.ref().update(updates).then(() => {
    // Update cards inline
    Object.entries(updates).forEach(([path, status]) => {
      const sid = path.split("/").pop(); // extract studentId
      const card = studentCards.find(c => c.getAttribute("data-id") === sid);
      if (card) {
        card.querySelector(".stats strong").textContent = status;
        const confirmBtn = card.querySelector(".btn.confirm");
        if (confirmBtn) confirmBtn.remove();
        card.querySelectorAll(".btn.present, .btn.absent")
            .forEach(btn => btn.classList.remove("selected"));
      }
    });

    tempAttendance = {}; // clear staged
    refreshAnalytics();
    updateConfirmAllButton();
  });
}




function updateConfirmAllButton() {
  const pendingCount = Object.keys(tempAttendance).length;
  const btn = document.querySelector(".controls .btn.primary");
  if (!btn) return;
  btn.textContent = pendingCount > 0
    ? `‚úÖ Confirm All (${pendingCount} pending)`
    : "‚úÖ Confirm All";
}


  async function refreshAnalytics() {
  if (!assignedClass) return;

  const d = selectedDate();
  const students = allStudentsMap;
  const total = students ? Object.keys(students).length : 0;

  // Fetch confirmed attendance
  const snap = await db.ref(`attendance/${assignedClass}/${d}`).once("value");
  const today = snap.val() || {};
  let present = 0, absent = 0;

  Object.values(today).forEach(v => {
    if (v === "Present") present++;
    if (v === "Absent") absent++;
  });

  // Count staged (unconfirmed) attendance
  const stagedCount = Object.keys(tempAttendance).length;

  // ‚úÖ Percentage based on total students, not just marked ones
  const percentToday = total ? Math.round((present / total) * 100) : 0;

  // Display KPIs
  document.getElementById('kpiPresent').textContent = present;
  document.getElementById('kpiAbsent').textContent = absent;
  document.getElementById('kpiPercent').textContent = percentToday + "%";

  // Summary section
  document.getElementById('sumTotal').textContent = total;
  document.getElementById('sumMarked').textContent =
    (present + absent) + (stagedCount ? ` (+${stagedCount} staged)` : ``);

  // Optional: confirmed percent for marked students (can keep it if needed)
  const confirmedPercent = (present + absent) && total ? Math.round((present / total) * 100) : 0;
  document.getElementById('sumPercent').textContent = confirmedPercent + "%";

  // 7-day sparkline
  drawSparkline(await last7DaysPercent(assignedClass));
}



    async function last7DaysPercent(classId){
      // returns array of 7 numbers (oldest‚Üínewest) of daily present%
      const out = [];
      const students = allStudentsMap;
      const total = students ? Object.keys(students).length : 0;
      for(let i=6;i>=0;i--){
        const dt = new Date(); dt.setDate(dt.getDate()-i);
        const day = dt.toISOString().split('T')[0];
        const snap = await db.ref(`attendance/${classId}/${day}`).once("value");
        const val = snap.val() || {};
        let present=0;
        Object.values(val).forEach(v=>{ if(v==="Present") present++; });
        out.push(total ? Math.round((present/total)*100) : 0);
      }
      return out;
    }

    function drawSparkline(points){
      const c = document.getElementById('trend'); if(!c) return;
      const ctx = c.getContext('2d');
      const w = c.width = c.offsetWidth, h = c.height = c.offsetHeight;
      ctx.clearRect(0,0,w,h);
      // axes (muted)
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border');
      ctx.lineWidth = 1; ctx.beginPath();
      ctx.moveTo(0,h-1); ctx.lineTo(w,h-1); ctx.stroke();

      if(!points || !points.length) return;
      const max = 100, min = 0;
      const step = w / (points.length-1 || 1);
      // line
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary-2') || '#00a1b3';
      ctx.lineWidth = 2; ctx.beginPath();
      points.forEach((p,idx)=>{
        const x = idx*step;
        const y = h - ( (p-min)/(max-min) ) * h;
        if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
      // fill
      const grd = ctx.createLinearGradient(0,0,0,h);
      grd.addColorStop(0,'rgba(0,188,212,.35)');
      grd.addColorStop(1,'rgba(0,188,212,0)');
      ctx.fillStyle = grd; ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath(); ctx.fill();
    }

    // ==== Utilities ====
    function filterStudents(){
      const q = (document.getElementById('studentSearch').value || "").toLowerCase().trim();
      const container = document.getElementById('studentContainer');
      container.innerHTML = "";
      studentCards.forEach(card=>{
        const name = card.getAttribute('data-name') || '';
        if(name.includes(q)) container.appendChild(card);
      });
      if(!container.children.length){
        const div = document.createElement('div'); div.className='mini'; div.textContent='No students match your search.';
        container.appendChild(div);
      }
    }

    function downloadCSV(){
      if(!assignedClass) return;
      db.ref("classes/"+assignedClass+"/students").once("value").then(snapshot=>{
        const students = snapshot.val(); if(!students) return;
        let csv = "Student ID,Student Name\n";
        for(const [id,name] of Object.entries(students)){ csv += `${id},${name}\n`; }
        const blob = new Blob([csv],{type:"text/csv"}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${assignedClass}_students.csv`; a.click();
        URL.revokeObjectURL(url);
      });
    }

    // üîπ Load all classes into homework dropdown
// Call this whenever the assignedClass changes (after onClassSelect)
async function loadSubjectsForHomework() {
  const container = document.getElementById("subjectHomeworkContainer");
  if (!assignedClass) return container.innerHTML = "<p>Select a class first.</p>";

  const snap = await db.ref(`classes/${assignedClass}/subjects`).once("value");
  const subjects = snap.val() || {};

  if (!Object.keys(subjects).length) {
    return container.innerHTML = "<p>No subjects added yet.</p>";
  }

  let html = "";
  Object.keys(subjects).forEach(sub => {
    html += `
      <div class="subject-homework">
        <h4>${sub}</h4>
        <textarea id="hw_${sub}" placeholder="Enter ${sub} homework..."></textarea>
        <button onclick="submitHomework('${sub}')">üì§ Submit</button>
      </div>
    `;
  });

  container.innerHTML = html;
}


// Submit homework for the selected class and subject
async function submitHomework(subject) {
  if (!assignedClass) return alert("No class selected!");
  const text = document.getElementById(`hw_${subject}`).value.trim();
  if (!text) return alert(`Enter homework for ${subject}`);
  const date = new Date().toISOString().split('T')[0];
  await db.ref(`homework/${assignedClass}/${date}/${subject}`).set(text);
  alert(`Homework for ${subject} uploaded successfully!`);
}

// üîπ Update on class selection
async function onClassSelect(classId){
  if(!classId) return;
  assignedClass = classId;
  document.getElementById('className').textContent = classId;
  tempAttendance = {};
  await loadStudents(classId);
  attachAttendanceListener();
  refreshAnalytics();
  await loadSubjectsForHomework(); // <-- load homework subjects automatically
}



    function deleteStudent(studentId, studentName){
      if(!confirm(`Remove ${studentName}?`)) return;
      db.ref(`classes/${assignedClass}/students/${studentId}`).remove().then(()=>{
        loadStudents(assignedClass); refreshAnalytics();
      });
    }

    let currentStudentUID = '';

let teacherMessageListener = null;

// ===== OPEN TEACHER MESSAGE MODAL =====
function openTeacherMessageModal(studentUID, studentName) {
  currentStudentUid = studentUID;
  const modal = document.getElementById('teacherMessageModal');
  modal.style.display = 'flex';
  document.getElementById('modalStudentName').textContent = studentName;

  loadTeacherMessages();
}

// ===== CLOSE TEACHER MESSAGE MODAL =====
function closeTeacherMessageModal() {
  const modal = document.getElementById('teacherMessageModal');
  modal.style.display = 'none';
  document.getElementById('teacherMessageInput').value = '';
  document.getElementById('teacherMessageHistory').innerHTML = '';

  if (teacherMessageListener) {
    const teacherUID = auth.currentUser.uid;
    db.ref(`messages/${currentStudentUid}/${teacherUID}`).off('child_added', teacherMessageListener);
    teacherMessageListener = null;
  }
}

// ===== LOAD MESSAGES FOR TEACHER =====
function loadTeacherMessages() {
  const historyDiv = document.getElementById('teacherMessageHistory');
  historyDiv.innerHTML = '';
  const teacherUID = auth.currentUser.uid;

  // Remove old listener if open again
  if (teacherMessageListener) {
    db.ref(`messages/${currentStudentUid}/${teacherUID}`).off('child_added', teacherMessageListener);
  }

  // First, load all messages sorted by timestamp
  db.ref(`messages/${currentStudentUid}/${teacherUID}`)
    .orderByChild('timestamp')
    .once('value', async snap => {
      historyDiv.innerHTML = '';
      const msgs = [];

      snap.forEach(childSnap => {
        const msgData = childSnap.val();
        if (!msgData) return;
        msgs.push(msgData);
      });

      renderMessages(msgs, historyDiv);
    });

  // Then, listen for **new** messages only
  teacherMessageListener = db.ref(`messages/${currentStudentUid}/${teacherUID}`)
    .orderByChild('timestamp')
    .startAt(Date.now()) // prevents reloading existing ones
    .on('child_added', snap => {
      const msgData = snap.val();
      if (!msgData) return;
      appendMessage(msgData, historyDiv);
    });
}

// ===== Helper: render all messages initially =====
function renderMessages(msgs, container) {
  msgs.sort((a, b) => a.timestamp - b.timestamp);
  msgs.forEach(msgData => appendMessage(msgData, container));
  container.scrollTop = container.scrollHeight;
}

// ===== Helper: append a single message =====
function appendMessage(msgData, container) {
  const { text, senderName, senderRole, timestamp } = msgData;

  const msgDiv = document.createElement('div');
  msgDiv.style.marginBottom = '6px';
  msgDiv.style.padding = '6px 10px';
  msgDiv.style.borderRadius = '10px';
  msgDiv.style.maxWidth = '80%';
  msgDiv.style.wordBreak = 'break-word';
  msgDiv.style.background = senderRole === 'teacher' ? '#00bcd4' : '#e0e0e0';
  msgDiv.style.color = senderRole === 'teacher' ? '#fff' : '#000';
  msgDiv.style.alignSelf = senderRole === 'teacher' ? 'flex-start' : 'flex-end';
  msgDiv.innerHTML = `<strong>${senderName}:</strong> ${text}<br><small style="font-size:10px; opacity:0.7;">${new Date(timestamp).toLocaleString()}</small>`;

  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
}

// ===== SEND MESSAGE FROM TEACHER =====
async function sendTeacherMessage() {
  const teacherUID = auth.currentUser.uid;
  const msgInput = document.getElementById('teacherMessageInput');
  const msg = msgInput.value.trim();
  if (!msg) return alert("Enter message!");

  // Get teacher info
  const teacherSnap = await db.ref(`users/${teacherUID}`).once('value');
  const teacherData = teacherSnap.val();

  const timestamp = Date.now();

  await db.ref(`messages/${currentStudentUid}/${teacherUID}/${timestamp}`).set({
    text: msg,
    senderName: teacherData.name,
    senderRole: "teacher",
    senderUid: teacherUID,
    timestamp
  });

  msgInput.value = '';
}

    
    </script>
</body>
</html>
